<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PHEXIA AI Chat (Versão Alpha)</title>
    <style>
        :root {
            --font-family: Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            --modal-overlay-bg: rgba(0,0,0,0.75); 
            --code-bg-base: #1e1e1e;

            --border-radius-sm: 4px;
            --border-radius-md: 8px;
            --border-radius-lg: 12px;
            --border-radius-xl: 16px;
            --border-radius-full: 9999px;

            --shadow-xs: 0 1px 2px 0 rgba(0,0,0,0.03);
            --shadow-sm: 0 1px 3px 0 rgba(0,0,0,0.07), 0 1px 2px -1px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
            --shadow-xl: 0 20px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1);
            --shadow-inner: inset 0 2px 4px 0 rgba(0,0,0,0.05);
        }
        body, :root {
            --bg-color: #1f2128; --sidebar-bg: #1f2128; --chat-bg: #282a36;
            --input-bg: #3a3d4a; --border-color: #4a4e5e; --text-color: #f0f0f5;
            --text-secondary-color: #a0a8c2; --accent-color: #00c2a3; --hover-bg: #313440;
            --danger-color: #ff5555; --danger-hover-bg: #e04444;
            --code-bg: var(--code-bg-base);
            --modal-content-bg: #313440;
            --blockquote-bg: rgba(255,255,255,0.04);
            --table-th-bg: rgba(255,255,255,0.06);
            --scrollbar-thumb: #5a5f73;
            --scrollbar-thumb-hover: #727890;
            --button-default-bg: transparent;
            --button-default-border: var(--border-color);
            --button-default-text: var(--text-color);
            --button-default-hover-bg: var(--hover-bg);
            --info-bg: rgba(255, 255, 255, 0.05);
            --info-border: rgba(255, 255, 255, 0.1);
            --button-secondary-bg: var(--input-bg);
            --button-secondary-border: var(--border-color);
            --button-secondary-text: var(--text-secondary-color);
            --button-secondary-hover-bg: var(--hover-bg);
            --button-secondary-hover-text: var(--text-color);
            --accent-color-darker: color-mix(in srgb, var(--accent-color) 80%, #000);
            --accent-color-hover: color-mix(in srgb, var(--accent-color) 90%, #000);
        }
        body.light-theme, :root.light-theme {
            --bg-color: #f8f9fa; --sidebar-bg: #f8f9fa; --chat-bg: #ffffff;
            --input-bg: #edf2f7; --border-color: #d1d9e6; --text-color: #2d3748;
            --text-secondary-color: #718096; --accent-color: #00a188; --hover-bg: #e2e8f0;
            --danger-color: #e53e3e; --danger-hover-bg: #c53030;
            --code-bg: #f1f3f5;
            --modal-content-bg: #ffffff;
            --blockquote-bg: #f9fafb;
            --table-th-bg: #f1f3f5;
            --scrollbar-thumb: #a0aec0;
            --scrollbar-thumb-hover: #718096;
            --button-default-bg: #e2e8f0;
            --button-default-border: #cad3e0;
            --button-default-text: var(--text-color);
            --button-default-hover-bg: #d1d9e6;
            --info-bg: rgba(0, 0, 0, 0.03);
            --info-border: rgba(0, 0, 0, 0.08);
            --button-secondary-bg: #e2e8f0;
            --button-secondary-border: #cad3e0;
            --button-secondary-text: var(--text-secondary-color);
            --button-secondary-hover-bg: #d1d9e6;
            --button-secondary-hover-text: var(--text-color);
            --accent-color-darker: color-mix(in srgb, var(--accent-color) 85%, #000);
            --accent-color-hover: color-mix(in srgb, var(--accent-color) 90%, #000);
        }
        html, body { box-sizing: border-box; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;}
        *, *:before, *:after { box-sizing: inherit; }
        body {
            font-family: var(--font-family); margin: 0; background-color: var(--bg-color);
            color: var(--text-color); display: flex; height: 100vh; width: 100vw;
            overflow: hidden; transition: background-color 0.3s ease, color 0.3s ease;
        }
        .chat-app-container { display: flex; width: 100%; height: 100%; overflow: hidden; }
        .sidebar {
            width: 260px; background-color: var(--sidebar-bg); padding: 16px; 
            display: flex; flex-direction: column; border-right: 1px solid var(--border-color);
            overflow-y: auto;
            transition: width 0.3s ease, padding 0.3s ease, transform 0.3s ease, background-color 0.3s ease, border-color 0.3s ease;
            flex-shrink: 0; z-index: 1001;
        }
        .sidebar.collapsed { width: 0; padding: 16px 0; overflow: hidden; border-right: none; }
        @media (max-width: 768px) {
            .sidebar {
                position: fixed; top: 0; left: 0; height: 100%; width: 260px; padding: 16px;
                transform: translateX(-100%); box-shadow: var(--shadow-lg);
            }
            .sidebar.open { transform: translateX(0); }
            .sidebar.collapsed { transform: translateX(-100%); width: 260px; padding: 16px; }
        }
        .sidebar-button {
            background-color: var(--button-default-bg); color: var(--button-default-text); border: 1px solid var(--button-default-border);
            padding: 10px 15px; border-radius: var(--border-radius-md); cursor: pointer; font-size: 0.9em;
            text-align: left; display: flex; align-items: center; gap: 12px; margin-bottom: 10px; 
            transition: background-color 0.2s ease-out, color 0.2s ease-out, border-color 0.2s ease-out, box-shadow 0.2s ease-out, transform 0.15s ease-out; 
            white-space: nowrap; font-weight: 500;
        }
        .sidebar-button:hover { 
            background-color: var(--hover-bg); color: var(--accent-color); border-color: var(--accent-color); 
            box-shadow: var(--shadow-sm); transform: translateY(-1px);
        }
        .sidebar-button svg { width: 18px; height: 18px; flex-shrink: 0; fill: currentColor; }
        
        #userMemoryInfo, #suggestedPersonaInfo {
            font-size: 0.8em; color: var(--text-secondary-color);
            padding: 12px 16px; margin-bottom: 12px; border: 1px dashed var(--border-color);
            border-radius: var(--border-radius-md); line-height: 1.6; background-color: var(--info-bg);
        }
        #userMemoryInfo strong, #suggestedPersonaInfo strong { color: var(--text-color); font-weight: 600; }
        #userMemoryInfo a, #suggestedPersonaInfo a { color: var(--accent-color); text-decoration: none; font-weight: 500;}
        #userMemoryInfo a:hover, #suggestedPersonaInfo a:hover { text-decoration: underline; }
        #suggestedPersonaInfo button {
            background-color: var(--accent-color); color: white; border: none;
            padding: 6px 12px; font-size: 0.9em; border-radius: var(--border-radius-sm); cursor: pointer; margin-left: 8px; margin-top: 6px; font-weight: 500;
            transition: background-color 0.2s ease-out, opacity 0.2s ease-out;
        }
        #suggestedPersonaInfo button:hover { background-color: var(--accent-color-hover); opacity: 0.95; }
        
        .sidebar-footer-buttons { margin-top: auto; padding-top: 10px; border-top: 1px solid var(--border-color); }
        #clearAllConversationsBtn { color: var(--danger-color); border-color: var(--danger-color); margin-top: 10px; background-color: transparent; }
        #clearAllConversationsBtn:hover { background-color: var(--danger-hover-bg); color: var(--bg-color); border-color: var(--danger-hover-bg); }
        
        #conversationList { list-style: none; padding: 0; margin: 0; flex-grow: 1; overflow-y: auto; margin-top:10px;}
        #conversationList li {
            display: flex; justify-content: space-between; align-items: center; padding: 10px 15px;
            border-radius: var(--border-radius-md); cursor: pointer; font-size: 0.9em; margin-bottom: 8px; 
            transition: background-color 0.2s ease-out, color 0.2s ease-out, border-left-color 0.25s ease, padding-left 0.25s ease, transform 0.15s ease-out;
            border: 1px solid transparent; position: relative; border-left: 4px solid transparent;
        }
        #conversationList li .conv-title { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-grow: 1; margin-right: 10px; font-weight: 500; }
        #conversationList li .conv-persona { font-size: 0.75em; color: var(--text-secondary-color); margin-left: 5px; background-color: color-mix(in srgb, var(--input-bg) 70%, transparent); padding: 3px 8px; border-radius: var(--border-radius-sm); white-space: nowrap; transition: background-color 0.3s ease, color 0.3s ease; }
        #conversationList li:hover { background-color: var(--hover-bg); border-left-color: var(--accent-color); transform: translateX(3px); }
        #conversationList li.active {
            background-color: var(--accent-color); color: white; font-weight: 600;
            border-left: 4px solid color-mix(in srgb, var(--accent-color) 70%, transparent);
            padding-left: 11px; box-shadow: var(--shadow-inner);
        }
        body.light-theme #conversationList li.active .conv-persona { color: color-mix(in srgb, white 85%, var(--accent-color)); background-color: color-mix(in srgb, var(--accent-color) 80%, white); }
        .delete-conv-btn {
            background: none; border: none; color: var(--text-secondary-color); cursor: pointer;
            padding: 4px; display: none; position: absolute; right: 10px; top: 50%;
            transform: translateY(-50%); opacity: 0.7; transition: color 0.2s ease-out, opacity 0.2s ease-out;
        }
        #conversationList li:hover .delete-conv-btn { display: inline-flex; }
        #conversationList li.active .delete-conv-btn { color: white; opacity: 0.85; }
        .delete-conv-btn:hover { color: var(--danger-color); opacity: 1; }
        #conversationList li.active .delete-conv-btn:hover { color: color-mix(in srgb, var(--danger-color) 70%, white); }
        .delete-conv-btn svg { width: 14px; height: 14px; fill: currentColor;}
        
        .main-chat-area { flex-grow: 1; display: flex; flex-direction: column; background-color: var(--chat-bg); overflow: hidden; transition: background-color 0.3s ease; }
        .chat-header {
            padding: 12px 24px; background-color: var(--sidebar-bg); display: flex; align-items: center;
            flex-shrink: 0; min-height: 60px; box-sizing: border-box; border-bottom: 1px solid var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease; position: relative;
        }
        #toggleSidebarBtn {
            background: none; border: none; color: var(--text-secondary-color); cursor: pointer;
            padding: 6px; margin-right: 12px; display: none; border-radius: var(--border-radius-sm);
            transition: color 0.2s ease-out, background-color 0.2s ease-out;
        }
        #toggleSidebarBtn:hover { color: var(--text-color); background-color: var(--hover-bg); }
        #toggleSidebarBtn svg { width: 24px; height: 24px; fill: currentColor; }

        .chat-title-container { display: flex; align-items: center; justify-content: center; flex: 1; overflow: hidden; }
        .chat-header h1 {
            margin: 0; font-size: 1.1em; font-weight: 600; color: var(--text-color);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; transition: color 0.3s ease;
        }
        .chat-header .persona-indicator {
            font-size: 0.8em; color: var(--text-secondary-color); font-style: normal; 
            transition: color 0.3s ease; white-space: nowrap; margin-left: 10px; flex-shrink: 0;
            background-color: color-mix(in srgb, var(--input-bg) 50%, transparent); padding: 3px 8px; border-radius: var(--border-radius-sm);
        }
        .chat-header .active-collaborator-indicator, .chat-header .sussurro-indicator {
            font-size: 0.7em; color: var(--accent-color); background-color: color-mix(in srgb, var(--accent-color) 15%, transparent); 
            border: 1px solid color-mix(in srgb, var(--accent-color) 40%, transparent);
            padding: 2px 6px; border-radius: var(--border-radius-sm); margin-left: 8px; font-weight: 500;
            white-space: nowrap; flex-shrink: 0; text-transform: uppercase; letter-spacing: 0.5px;
        }
        body.light-theme .chat-header .active-collaborator-indicator, body.light-theme .chat-header .sussurro-indicator { background-color: color-mix(in srgb, var(--accent-color) 10%, transparent); }

        #headerThemeToggleBtn {
            background: none; border: none; color: var(--text-secondary-color); cursor: pointer;
            padding: 6px; margin-left: 12px; display: flex; align-items: center; flex-shrink: 0; border-radius: var(--border-radius-sm);
            transition: color 0.2s ease-out, background-color 0.2s ease-out;
        }
        #headerThemeToggleBtn:hover { color: var(--text-color); background-color: var(--hover-bg); }
        #headerThemeToggleBtn svg { width: 18px; height: 18px; fill: currentColor; }
        
        @media (max-width: 768px) {
            #toggleSidebarBtn { display: inline-flex; } 
            .chat-header { padding: 10px 15px; min-height: 56px;}
            .chat-header h1 { font-size: 1em; flex-grow: 0; max-width: 90px; } 
            .chat-header .persona-indicator { font-size: 0.7em; margin-left: 6px; max-width: 60px; }
            .chat-header .active-collaborator-indicator, .chat-header .sussurro-indicator { font-size: 0.65em; margin-left: 6px;}
            #headerThemeToggleBtn { margin-left: 6px; }
            #headerThemeToggleBtn svg { width: 16px; height: 16px; }
            .chat-title-container { justify-content: flex-start; margin-right: auto; }
        }
        @media (min-width: 769px) { .chat-title-container { justify-content: center; } }
        
        .chat-messages { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 4px; } 
        .messages-content-wrapper { width: 100%; max-width: 800px; margin: 0 auto; display: flex; flex-direction: column; gap: 4px; }
        .message-wrapper { display: flex; gap: 16px; align-items: flex-start; position: relative; padding-top: 10px; }
        .message-wrapper.grouped { padding-top: 4px; margin-left: 48px; }
        .message-wrapper.grouped .message-avatar { display: none; }
        .message-wrapper.grouped .message { border-radius: var(--border-radius-md); }
        .collab-avatar { border: 2px dashed var(--accent-color); box-shadow: 0 0 8px -2px var(--accent-color); } 
        .copy-code-btn { position: absolute; top: 10px; right: 10px; background-color: color-mix(in srgb, var(--code-bg) 80%, #000); color: var(--text-secondary-color); border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); padding: 5px 10px; font-size: 0.8em; cursor: pointer; opacity: 0; transition: opacity 0.2s ease-out, background-color 0.2s ease-out, color 0.2s ease-out; z-index: 10; }
        body.light-theme .copy-code-btn { background-color: color-mix(in srgb, var(--code-bg) 80%, #fff); }
        .message-wrapper:hover .copy-code-btn { opacity: 1; }
        .copy-code-btn:hover { background-color: var(--accent-color); color: white; }
        
        .message-avatar { width: 32px; height: 32px; border-radius: var(--border-radius-sm); display: flex; align-items: center; justify-content: center; font-weight: 500; color: white; font-size: 0.9em; flex-shrink: 0; margin-top: 3px; transition: background-color 0.3s ease, box-shadow 0.2s ease; }
        .user-avatar { background-color: #6b7280; } 
        .bot-avatar { background-color: var(--accent-color); }
        body.light-theme .user-avatar { background-color: #9ca3af; }
        .bot-avatar svg { width: 18px; height: 18px; fill: white; }
        
        .message { padding: 10px 14px; line-height: 1.65; color: var(--text-color); width: 100%; transition: color 0.3s ease, background-color 0.3s ease; border-radius: var(--border-radius-lg); white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word; font-size: 0.95rem; }
        .user-message-wrapper .message { background-color: var(--input-bg); }
        .bot-message-wrapper .message { background-color: var(--hover-bg); } 
        body.light-theme .user-message-wrapper .message { background-color: #e9ecef; }
        body.light-theme .bot-message-wrapper .message { background-color: #f8f9fa; border: 1px solid #e9ecef; }
        
        .message p { margin-top: 0; margin-bottom: 0.8em; } .message p:last-child { margin-bottom: 0; } .message h1, .message h2, .message h3, .message h4, .message h5, .message h6 { margin-top: 1.4em; margin-bottom: 0.7em; line-height: 1.3; font-weight: 600; color: var(--text-color); transition: color 0.3s ease;} .message h1 { font-size: 1.7em; } .message h2 { font-size: 1.4em; } .message h3 { font-size: 1.2em; } .message h4 { font-size: 1.05em; } .message h5 { font-size: 1em; } .message h6 { font-size: 0.9em; } .message ul, .message ol { padding-left: 28px; margin: 1em 0; } .message li { margin-bottom: 0.4em; } .message blockquote { margin: 1em 0; padding: 0.8em 1.2em; border-left: 4px solid var(--accent-color); background-color: var(--blockquote-bg); color: var(--text-secondary-color); transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; border-radius: 0 var(--border-radius-sm) var(--border-radius-sm) 0;} .message blockquote p { margin-bottom: 0.5em; } .message hr { border: 0; border-top: 1px solid var(--border-color); margin: 1.8em 0; transition: border-color 0.3s ease;} .message a { color: var(--accent-color); text-decoration: none; font-weight: 500; transition: color 0.2s ease-out, text-decoration-color 0.2s ease-out;} .message a:hover { text-decoration: underline; text-decoration-color: color-mix(in srgb, var(--accent-color) 70%, transparent); color: var(--accent-color-hover); } .message table { border-collapse: separate; border-spacing: 0; margin: 1.2em 0; width: auto; font-size: 0.9em; border: 1px solid var(--border-color); border-radius: var(--border-radius-md); overflow: hidden;} .message th, .message td { border-bottom: 1px solid var(--border-color); padding: 10px 14px; text-align: left; transition: border-color 0.3s ease, background-color 0.3s ease;} .message th { background-color: var(--table-th-bg); font-weight: 600;} .message tr:last-child td { border-bottom: none;} .message pre { background-color: var(--code-bg); padding: 1.2em; border-radius: var(--border-radius-md); overflow-x: auto; font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace; font-size: 0.85em; border: 1px solid var(--border-color); margin: 12px 0; white-space: pre-wrap; word-break: break-all; position: relative; transition: background-color 0.3s ease, border-color 0.3s ease; box-shadow: var(--shadow-inner);} .message code:not(pre code) { background-color: color-mix(in srgb, var(--code-bg) 80%, transparent); padding: 0.25em 0.5em; border-radius: var(--border-radius-sm); font-size: 0.875em; border: 1px solid var(--border-color); } .message strong, .message b { font-weight: 600; } .message em, .message i { font-style: italic; }
        .bot-message-wrapper .message.streaming::after { content: '▋'; animation: blink 1s step-end infinite; margin-left: 3px; font-weight: bold; color: var(--accent-color);} @keyframes blink { 50% { opacity: 0; } }
        .bot-message.error .message { color: #ffacac; padding-left: 12px; border-left: 4px solid var(--danger-color); background-color: color-mix(in srgb, var(--danger-color) 15%, transparent) !important; white-space: pre-wrap; }
        body.light-theme .bot-message.error .message { color: #9b2c2c; background-color: #fed7d7 !important; }
        .system-feedback-message { font-style: italic; font-size: 0.9em; color: var(--text-secondary-color); padding: 8px 0; text-align: center; opacity: 0.8; }

        .stop-generation-btn-wrapper { display: flex; justify-content: center; padding: 0 0 12px 0; flex-shrink: 0; }
        #stopGenerationBtn { background-color: var(--input-bg); color: var(--text-secondary-color); border: 1px solid var(--border-color); padding: 9px 18px; border-radius: var(--border-radius-md); cursor: pointer; font-size: 0.875em; font-weight: 500; transition: all 0.2s ease-out; }
        #stopGenerationBtn:hover { background-color: var(--hover-bg); color: var(--text-color); box-shadow: var(--shadow-sm); transform: translateY(-1px);}
        
        .loading-indicator { display: flex; align-items: center; justify-content: center; gap: 12px; padding: 18px 20px; color: var(--text-secondary-color); background-color: var(--chat-bg); flex-shrink: 0; transition: background-color 0.3s ease, color 0.3s ease;}
        .spinner { width: 20px; height: 20px; border: 3px solid var(--text-secondary-color); border-top-color: var(--accent-color); border-radius: 50%; animation: spin 0.8s linear infinite; transition: border-color 0.3s ease;}
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .chat-input-area-wrapper { width: 100%; padding: 0 12px 12px 12px; background-color: var(--chat-bg); box-sizing: border-box; flex-shrink: 0; border-top: 1px solid var(--border-color); transition: background-color 0.3s ease, border-color 0.3s ease; }
        .chat-input-container { max-width: 800px; margin: 0 auto; position: relative; }
        #file-info-display {
            display: none; align-items: center; gap: 10px; padding: 5px 14px; font-size: 0.85em;
            color: var(--text-secondary-color); background-color: var(--input-bg); border: 1px solid var(--border-color);
            border-bottom: none; border-top-left-radius: var(--border-radius-md); border-top-right-radius: var(--border-radius-md); margin-top: 10px;
        }
        #fileNameDisplay { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex-grow: 1; font-weight: 500; }
        #removeFileBtn {
            background: none; border: none; color: var(--danger-color); cursor: pointer;
            font-size: 1.3em; padding: 0; line-height: 1; opacity: 0.8; transition: opacity 0.2s ease-out;
        }
        #removeFileBtn:hover { opacity: 1; }
        
        .chat-input-area {
            display: flex; align-items: flex-end; padding: 12px; border: 1px solid var(--border-color);
            border-radius: var(--border-radius-xl); background-color: var(--input-bg); gap: 10px; /* Adjusted gap */ position: relative;
            box-shadow: var(--shadow-md); transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .chat-input-area:focus-within { border-color: var(--accent-color); box-shadow: 0 0 0 2px color-mix(in srgb, var(--accent-color) 30%, transparent), var(--shadow-lg); }
        body.light-theme .chat-input-area { box-shadow: var(--shadow-sm); }
        body.light-theme .chat-input-area:focus-within { box-shadow: 0 0 0 2px color-mix(in srgb, var(--accent-color) 20%, transparent), var(--shadow-md); }
        
        #chatActionsBtn, #fileUploadBtn { 
            background: transparent; border: none; color: var(--text-secondary-color); padding: 0;
            width: 36px; height: 36px; border-radius: var(--border-radius-md); cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: color 0.2s ease-out, background-color 0.2s ease-out; flex-shrink: 0; margin-bottom: 2px;
        }
        #chatActionsBtn { margin-right: 4px; }
        #fileUploadBtn { margin-right: 6px; display: none; } 
        #chatActionsBtn:hover, #fileUploadBtn:hover { color: var(--accent-color); background-color: var(--hover-bg); }
        #chatActionsBtn svg, #fileUploadBtn svg { width: 20px; height: 20px; fill: currentColor; }
        #fileInput { display: none; }
        .chat-input-area textarea { flex-grow: 1; padding: 10px 12px; border: none; resize: none; background-color: transparent; color: var(--text-color); font-size: 1rem; line-height: 1.6; max-height: 180px; overflow-y: auto; outline: none; transition: color 0.3s ease; }
        .chat-input-area textarea::placeholder { color: var(--text-secondary-color); transition: color 0.3s ease; opacity: 0.8;}
        .chat-input-area button#sendButton {
             background-color: var(--text-secondary-color); color: var(--input-bg); border: none; width: 36px; height: 36px;
             border-radius: var(--border-radius-md); cursor: pointer; display: flex; align-items: center; justify-content: center;
             transition: background-color 0.2s ease-out, color 0.2s ease-out, transform 0.1s ease-out; flex-shrink: 0; margin-bottom: 2px;
        }
        .chat-input-area textarea:not(:placeholder-shown) ~ button#sendButton, 
        .chat-input-area button#sendButton:hover:not(:disabled) { background-color: var(--accent-color); }
        .chat-input-area button#sendButton:active:not(:disabled) { transform: scale(0.95); }
        .chat-input-area button#sendButton svg { width: 18px; height: 18px; stroke: currentColor; stroke-width: 2.5; }
        body.light-theme .chat-input-area button#sendButton { color: var(--text-color); }
        .chat-input-area button#sendButton:disabled { background-color: var(--text-secondary-color); opacity: 0.6; cursor: not-allowed; }
        
        .token-counter { font-size: 0.8em; color: var(--text-secondary-color); text-align: right; padding: 6px 18px 0 0; max-width: 800px; margin: 0 auto; transition: color 0.3s ease; opacity: 0.9; }
        .token-counter.warning { color: #f39c12; }
        body.light-theme .token-counter.warning { color: #d97706; }
        .token-counter.error { color: var(--danger-color); font-weight: 500; }
        .footer-info { text-align: center; padding: 12px 20px; font-size: 0.8em; color: var(--text-secondary-color); background-color: var(--chat-bg); flex-shrink: 0; max-width: 800px; margin: 0 auto; transition: background-color 0.3s ease, color 0.3s ease; opacity: 0.8; }
        
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: var(--modal-overlay-bg); align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal-content { background-color: var(--modal-content-bg); margin: auto; padding: 28px 32px; border: 1px solid var(--border-color); border-radius: var(--border-radius-xl); width: 90%; max-width: 550px; box-shadow: var(--shadow-xl); position: relative; color: var(--text-color); max-height: 90vh; display: flex; flex-direction: column; transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease, box-shadow 0.3s ease; }
        .modal-content.modal-lg { max-width: 750px; }
        .modal-content .modal-scrollable-content { overflow-y: auto; flex-grow: 1; padding-right: 12px; margin-right: -12px; }
        .close-modal-btn { color: var(--text-secondary-color); position: absolute; top: 12px; right: 16px; font-size: 30px; font-weight: bold; line-height: 1; transition: color 0.2s ease-out; }
        .close-modal-btn:hover, .close-modal-btn:focus { color: var(--text-color); text-decoration: none; cursor: pointer; }
        .modal-content h2 { margin-top: 0; margin-bottom: 20px; font-size: 1.5em; font-weight: 600; color: var(--text-color); }
        .modal-content h3 { margin-top: 24px; margin-bottom: 12px; font-size: 1.15em; font-weight: 500; color: var(--text-color); border-bottom: 1px solid var(--border-color); padding-bottom: 8px;}
        .modal-content p { font-size: 0.98em; line-height: 1.65; margin-bottom: 18px; }
        .modal-content p.small-info { font-size: 0.85em; color: var(--text-secondary-color); margin-top: -12px; margin-bottom: 18px;}
        .modal-content a { color: var(--accent-color); font-weight: 500; }
        .modal-content a:hover { color: var(--accent-color-hover); text-decoration: underline;}
        .modal-input-group { margin-bottom: 22px; }
        .modal-input-group label { display: block; margin-bottom: 10px; font-size: 0.95em; font-weight: 500; }
        .modal-input-group input[type="password"], .modal-input-group input[type="text"], .modal-input-group textarea, .modal-input-group select { width: 100%; padding: 12px; background-color: var(--input-bg); color: var(--text-color); border: 1px solid var(--border-color); border-radius: var(--border-radius-md); font-size: 1em; box-sizing: border-box; transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease, box-shadow 0.2s ease; }
        .modal-input-group input:focus, .modal-input-group textarea:focus, .modal-input-group select:focus { border-color: var(--accent-color); box-shadow: 0 0 0 2px color-mix(in srgb, var(--accent-color) 30%, transparent); outline: none;}
        .modal-input-group textarea { resize: vertical; min-height: 90px; max-height: 220px; }
        .modal-content button.modal-action-btn, .modal-content button.modal-secondary-btn { width: 100%; padding: 12px 18px; border-radius: var(--border-radius-md); cursor: pointer; font-size: 1em; font-weight: 500; transition: all 0.2s ease-out; margin-top: 12px; }
        .modal-content button.modal-action-btn { background-color: var(--accent-color); color: white; border: none; }
        .modal-content button.modal-action-btn:hover { background-color: var(--accent-color-hover); transform: translateY(-1px); box-shadow: var(--shadow-sm); }
        body.light-theme .modal-content button.modal-action-btn:hover { background-color: var(--accent-color-hover); }
        .modal-content button.modal-secondary-btn { background-color: var(--button-secondary-bg); color: var(--button-secondary-text); border: 1px solid var(--button-secondary-border); }
        .modal-content button.modal-secondary-btn:hover { background-color: var(--button-secondary-hover-bg); color: var(--button-secondary-hover-text); transform: translateY(-1px); box-shadow: var(--shadow-sm);}
        .modal-error-msg { color: var(--danger-color); font-size: 0.9em; margin-top: 12px; text-align: center; }
        
        #promptLibraryModal .modal-content { max-width: 650px; }
        #promptList { list-style: none; padding: 0; margin: 0 0 20px 0; max-height: 320px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: var(--border-radius-md); } #promptList li { padding: 12px 14px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; transition: border-color 0.3s ease, background-color 0.2s ease-out; } #promptList li:last-child { border-bottom: none; } #promptList li .prompt-title { font-weight: 500; flex-grow: 1; margin-right: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; } .prompt-actions button { background: var(--input-bg); color: var(--text-secondary-color); border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); padding: 6px 10px; font-size: 0.85em; cursor: pointer; margin-left: 6px; transition: all 0.2s ease-out; } .prompt-actions button:hover { background: var(--hover-bg); color: var(--text-color); transform: translateY(-1px); box-shadow: var(--shadow-xs); } .prompt-actions button.delete:hover { background: var(--danger-hover-bg); color: var(--bg-color); } #promptFormContainer { border: 1px solid var(--border-color); padding: 18px; border-radius: var(--border-radius-lg); margin-bottom: 22px; background-color: var(--info-bg); transition: background-color 0.3s ease, border-color 0.3s ease;} #promptFormContainer h3 { margin-top: 0; margin-bottom: 18px; font-size: 1.2em;}
        
        #personaSelectionModal .modal-content { max-width: 500px; }
        .persona-carousel-container { display: flex; align-items: center; justify-content: space-between; margin: 18px 0; min-height: 130px; }
        .persona-nav-btn {
            background: var(--input-bg); color: var(--text-color); border: 1px solid var(--border-color);
            border-radius: var(--border-radius-full); width: 44px; height: 44px; font-size: 1.6em; cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: all 0.2s ease-out;
            flex-shrink: 0; box-shadow: var(--shadow-sm);
        }
        .persona-nav-btn:hover { background-color: var(--hover-bg); transform: scale(1.05); box-shadow: var(--shadow-md); }
        .persona-nav-btn:disabled { opacity: 0.5; cursor: not-allowed; background-color: var(--input-bg); box-shadow: none; transform: none;}
        .current-persona-display { flex-grow: 1; padding: 0 24px; text-align: center; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #currentPersonaName { font-weight: 600; font-size: 1.2em; margin-bottom: 10px; color: var(--text-color); }
        #currentPersonaDescription { font-size: 0.95em; color: var(--text-secondary-color); line-height: 1.55; max-height: 65px; overflow-y: auto; }
        #selectCurrentPersonaBtn { margin-top: 12px; }
        #horarySuggestionInModal {
            font-size: 0.9em; color: var(--text-secondary-color); background-color: var(--info-bg);
            border: 1px solid var(--info-border); padding: 10px 14px; border-radius: var(--border-radius-md);
            margin-top: 18px; text-align: center;
        }
        #horarySuggestionInModal button {
            margin-left: 10px; background-color: var(--accent-color); color: white; border: none;
            padding: 5px 10px; border-radius: var(--border-radius-sm); cursor: pointer; font-size: 0.95em; font-weight: 500;
            transition: background-color 0.2s ease-out;
        }
        #horarySuggestionInModal button:hover { background-color: var(--accent-color-hover); }

        #userMemoryModal .modal-content { max-width: 650px; }
        #userMemoryTopicsList { list-style: none; padding:0; margin:0; max-height: 220px; overflow-y:auto; }
        #userMemoryTopicsList li { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border-color); font-size: 0.95em; }
        #userMemoryTopicsList li:last-child { border-bottom: none; }
        #userMemoryTopicsList button { font-size: 0.9em; padding: 4px 10px; margin-left: 12px; }

        .sidebar-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--modal-overlay-bg); z-index: 1000; 
            opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease, visibility 0s linear 0.3s;
        }
        .sidebar-overlay.visible { opacity: 1; visibility: visible; transition: opacity 0.3s ease, visibility 0s linear 0s; }
        
        ::-webkit-scrollbar { width: 7px; height: 7px; } 
        ::-webkit-scrollbar-track { background: transparent; } 
        ::-webkit-scrollbar-thumb { background-color: var(--scrollbar-thumb); border-radius: var(--border-radius-full); border: 1px solid var(--chat-bg); } 
        ::-webkit-scrollbar-thumb:hover { background-color: var(--scrollbar-thumb-hover); }
        
        @media (max-width: 768px) {
            .main-chat-area { width: 100%; }
            .chat-messages { padding: 15px; }
            .messages-content-wrapper { gap: 3px; max-width: 100%; }
            .message-wrapper.grouped { margin-left: 40px; }
            .copy-code-btn { font-size: 0.75em; padding: 4px 8px; }
            .chat-input-area-wrapper { padding: 0 8px 8px 8px; }
            .chat-input-area { padding: 10px; gap: 10px; }
            .chat-input-area textarea { padding: 9px 10px; font-size: 0.95rem; }
            #file-info-display { padding: 4px 10px; font-size: 0.8em;}
            #chatActionsBtn svg, #fileUploadBtn svg { width: 18px; height: 18px; }
            .token-counter { padding-right: 12px; }
            .footer-info { padding: 10px 12px; font-size: 0.75em; }
            .modal-content { width: 95%; padding: 22px; }
            .modal-content h2 { font-size: 1.35em; }
            .persona-nav-btn { width: 40px; height: 40px; font-size: 1.4em; }
            .current-persona-display { padding: 0 12px; }
            #currentPersonaName { font-size: 1.1em; }
            #currentPersonaDescription { font-size: 0.9em; max-height: 55px; }
            #horarySuggestionInModal { font-size: 0.85em; padding: 8px 12px; }
        }
    </style>
</head>
<body>
    <div class="chat-app-container">
        <div class="sidebar" id="sidebar">
            <div id="userMemoryInfo" style="display: none;"></div>
            <div id="suggestedPersonaInfo" style="display: none;"></div>
            <button id="newConversationBtn" class="sidebar-button">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-3 10h-3v3h-2v-3H9v-2h3V7h2v3h3v2z"></path></svg>
                Nova Conversa
            </button>
            <ul id="conversationList"></ul>
            <div class="sidebar-footer-buttons">
                <button id="createCustomIaSidebarBtn" class="sidebar-button">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 6.5A2.5 2.5 0 0 1 14.5 9a2.5 2.5 0 0 1-2.5 2.5A2.5 2.5 0 0 1 9.5 9a2.5 2.5 0 0 1 2.5-2.5M12 2a10 10 0 0 0-7.35 16.84l1.42-1.42A8 8 0 1 1 12 20a8 8 0 0 1-6.5-3.33V15H4v6h6v-1.5H5.67A9.96 9.96 0 0 0 12 22a10 10 0 0 0 10-10c0-3.46-1.76-6.5-4.4-8.28l1.42-1.42A10 10 0 0 0 12 2m6 12.5h-2.5v-2.5H14v2.5H11.5v1.5H14v2.5h1.5v-2.5H18Z"/></svg>
                    Criar IA Personalizada
                </button>
                 <button id="toolsMenuBtn" class="sidebar-button">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69-.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19-.15-.24.42-.12-.64l2 3.46c.12.22.39.3.61.22l2.49 1c.52.4 1.08.73 1.69-.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"></path></svg>
                    Ferramentas
                </button>
                <button id="openAutoConversationModeBtn" class="sidebar-button">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.18c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92s2.92-1.31 2.92-2.92-1.31-2.92-2.92-2.92z"></path></svg>
                    Observar IAs
                </button>
                <button id="clearAllConversationsBtn" class="sidebar-button"> <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"></path></svg> Apagar Todas </button>
            </div>
        </div>
        <div class="main-chat-area">
            <div class="chat-header">
                <button id="toggleSidebarBtn" title="Alternar barra lateral">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
                    </svg>
                </button>
                <div class="chat-title-container">
                    <h1 id="chatTitle">PHEXIA AI</h1>
                    <span id="personaIndicator" class="persona-indicator"></span>
                    <span id="activeCollaboratorIndicator" class="active-collaborator-indicator" style="display: none;"></span>
                    <span id="sussurroIndicator" class="sussurro-indicator" style="display: none;"></span>
                </div>
                <button id="headerThemeToggleBtn" title="Mudar tema">
                    <svg id="headerThemeIconLight" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" style="display:none;"><path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.64 5.64c-.39-.39-1.02-.39-1.41 0s-.39 1.02 0 1.41l1.06 1.06c.39.39 1.02.39 1.41 0s.39-1.02 0-1.41L5.64 5.64zm12.73 0l-1.06 1.06c-.39-.39-.39 1.02 0 1.41s1.02.39 1.41 0l1.06-1.06c.39-.39.39-1.02 0-1.41s-1.02-.39-1.41 0zM5.64 18.36l1.06-1.06c.39-.39 1.02-.39 1.41 0s.39 1.02 0 1.41l-1.06 1.06c-.39-.39-1.02-.39-1.41 0s-.39-1.02 0-1.41zm12.73 0c.39.39 1.02.39 1.41 0s.39-1.02 0-1.41l-1.06-1.06c-.39-.39-.39-1.02 0-1.41s1.02.39 1.41 0l1.06 1.06z"></path></svg>
                    <svg id="headerThemeIconDark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 2c-1.82 0-3.53.5-5 1.35C7.99 5.08 10 8.3 10 12s-2.01 6.92-5 8.65C6.47 21.5 8.18 22 10 22c5.52 0 10-4.48 10-10S15.52 2 10 2z"></path></svg>
                </button>
            </div>
            <div class="chat-messages" id="chatMessagesScroll"><div class="messages-content-wrapper" id="messagesContentWrapper"></div></div>
            <div class="stop-generation-btn-wrapper" id="stopGenerationBtnWrapper" style="display: none;"><button id="stopGenerationBtn">Parar Geração</button></div>
            <div class="loading-indicator" id="loadingIndicator" style="display: none;"><div class="spinner"></div> <span id="loadingText">PHEXIA AI está pensando...</span></div>
            <div class="chat-input-area-wrapper">
                <div class="chat-input-container">
                    <div id="file-info-display">
                        <span id="fileNameDisplay"></span>
                        <button id="removeFileBtn" title="Remover arquivo" style="display: none;">×</button>
                    </div>
                    <div class="chat-input-area">
                        <button id="chatActionsBtn" title="Ações da Conversa">
                             <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
                        </button>
                        <input type="file" id="fileInput" accept=".txt,.md,.csv,.js,.py,.html,.css,.json,text/*">
                        <button id="fileUploadBtn" title="Anexar arquivo">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.78,10.78,12,8.56l2.22,2.22a.75.75,0,1,0,1.06-1.06l-2.75-2.75a.75.75,0,0,0-1.06,0L8.72,9.72a.75.75,0,0,0,1.06,1.06ZM12,18a.75.75,0,0,0,.75-.75V10a.75.75,0,0,0-1.5,0v7.25A.75.75,0,0,0,12,18Z"></path><path d="M19.5,6H16V4.5A2.5,2.5,0,0,0,13.5,2h-3A2.5,2.5,0,0,0,8,4.5V6H4.5A2.5,2.5,0,0,0,2,8.5v10A2.5,2.5,0,0,0,4.5,21h15A2.5,2.5,0,0,0,22,18.5V8.5A2.5,2.5,0,0,0,19.5,6Zm-1.5,0H9.5V4.5a1,1,0,0,1,1-1h3a1,1,0,0,1,1,1Zm1.5,12.5a1,1,0,0,1-1,1H4.5a1,1,0,0,1-1-1v-10a1,1,0,0,1,1-1H19.5a1,1,0,0,1,1,1Z"></path></svg>
                        </button>
                        <textarea id="userInput" placeholder="Envie uma mensagem para PHEXIA AI..." rows="1"></textarea>
                        <button id="sendButton" title="Enviar mensagem">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M7 11L12 6L17 11M12 18V7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </button>
                    </div>
                    <div id="tokenCounter" class="token-counter">Tokens: 0 / 8192 (Estimativa)</div>
                </div>
            </div>
            <div class="footer-info" id="footerInfoText"> PHEXIA AI pode cometer erros. Considere verificar informações importantes. </div>
        </div>
    </div>

    <div id="chatActionsModal" class="modal">
        <div class="modal-content modal-lg">
            <span class="close-modal-btn" id="closeChatActionsModalBtn">×</span>
            <h2>Ações da Conversa</h2>
            <div class="modal-scrollable-content">
                <!-- Apelido -->
                <h3>Apelido</h3>
                <div class="modal-input-group">
                    <label for="chatActionsNicknameInput">Seu apelido:</label>
                    <input type="text" id="chatActionsNicknameInput" placeholder="Como você gostaria de ser chamado?">
                </div>
                <button id="chatActionsSaveNicknameBtn" class="modal-action-btn" style="margin-bottom: 5px;">Salvar Apelido</button>
                <button id="chatActionsClearNicknameBtn" class="modal-secondary-btn">Limpar Apelido</button>

                <!-- Modo Sussurro -->
                <h3>Modo Sussurro</h3>
                <div class="modal-input-group">
                    <label for="chatActionsSussurroModeSelect">Nível de detalhe da resposta:</label>
                    <select id="chatActionsSussurroModeSelect">
                        <option value="normal">Normal</option>
                        <option value="curto">Curto (Respostas concisas)</option>
                        <option value="elaborado">Elaborado (Respostas detalhadas)</option>
                    </select>
                </div>
                <button id="chatActionsApplySussurroBtn" class="modal-action-btn">Aplicar Modo Sussurro</button>

                <!-- Colaboração -->
                <h3>Colaboração entre IAs</h3>
                <div id="chatActionsCollabInviteSection">
                     <div class="modal-input-group">
                        <label for="chatActionsCollabPersonaSelect">Convidar Persona para esta conversa:</label>
                        <select id="chatActionsCollabPersonaSelect">
                            <option value="">-- Selecione uma Persona --</option>
                        </select>
                    </div>
                    <button id="chatActionsInvitePersonaBtn" class="modal-action-btn" disabled>Convidar Persona</button>
                </div>
                <div id="chatActionsCollabDismissSection" style="display:none;">
                    <p>Persona colaboradora ativa: <strong id="chatActionsCurrentCollabName"></strong></p>
                    <button id="chatActionsDismissPersonaBtn" class="modal-action-btn">Dispensar Colaborador</button>
                </div>
            </div>
        </div>
    </div>


    <div id="toolsModal" class="modal">
        <div class="modal-content">
            <span class="close-modal-btn" id="closeToolsModalBtn">×</span>
            <h2>Ferramentas e Configurações</h2>
            <div class="modal-scrollable-content">
                <button id="toolsMenuMyPromptsBtn" class="modal-action-btn">Meus Prompts</button>
                <button id="toolsMenuApiKeyBtn" class="modal-action-btn">Configurar Chave API</button>
                <button id="toolsMenuUserMemoryBtn" class="modal-action-btn">Gerenciar Minha Memória</button>
            </div>
        </div>
    </div>

    <div id="userMemoryModal" class="modal">
        <div class="modal-content modal-lg">
            <span class="close-modal-btn" id="closeUserMemoryModalBtn">×</span>
            <h2>Gerenciar Minha Memória</h2>
            <div class="modal-scrollable-content">
                <h3>Apelido</h3>
                <div class="modal-input-group">
                    <label for="userMemoryNicknameInput">Como devo te chamar?</label>
                    <input type="text" id="userMemoryNicknameInput" placeholder="Seu apelido">
                </div>
                <button id="userMemorySaveNicknameBtn" class="modal-action-btn" style="width: auto; padding: 8px 15px; font-size: 0.9em;">Salvar Apelido</button>
                <button id="userMemoryClearNicknameBtn" class="modal-secondary-btn" style="width: auto; padding: 8px 15px; font-size: 0.9em; margin-left: 10px;">Limpar Apelido</button>

                <h3>Tópicos de Interesse</h3>
                <p class="small-info">Estes são tópicos que notei que você mencionou com frequência.</p>
                <ul id="userMemoryTopicsList"></ul>
                <p id="userMemoryNoTopicsMsg" style="text-align:center; color: var(--text-secondary-color); display:none;">Nenhum tópico de interesse registrado ainda.</p>

                <h3>Persona Favorita</h3>
                <p class="small-info">Sua persona mais utilizada recentemente.</p>
                <div id="userMemoryFavoritePersonaDisplay" style="margin-bottom: 10px; font-weight: 500;"></div>
                <button id="userMemoryResetFavoritePersonaBtn" class="modal-secondary-btn" style="width: auto; padding: 8px 15px; font-size: 0.9em;">Redefinir para Padrão</button>

                <h3>Limpeza Geral</h3>
                <button id="userMemoryClearInteractionsBtn" class="modal-secondary-btn" style="border-color: var(--danger-color); color: var(--danger-color);">Esquecer Todos os Interesses e Apelido</button>
                <button id="userMemoryClearSuggestionsHistoryBtn" class="modal-secondary-btn">Limpar Histórico de Sugestões</button>
            </div>
        </div>
    </div>

    <div id="apiKeyModal" class="modal"> <div class="modal-content"> <span class="close-modal-btn" id="closeApiKeyModalBtn">×</span> <h2>Chave de acesso Phexia AI</h2> <p>Para utilizar o PHEXIA AI Chat, por favor, insira sua chave de acesso enviada em seu e-mail.<br> Você pode obter uma chave em <a href="https://console.groq.com/keys" target="_blank" rel="noopener noreferrer">Compre sua chave</a>.</p> <div class="modal-input-group"> <label for="modalUserApiKeyInput">Sua chave de acesso:</label> <input type="password" id="modalUserApiKeyInput" placeholder="Cole sua chave de acesso"> </div> <button id="modalSaveUserApiKeyBtn" class="modal-action-btn">Salvar e Usar Chave</button> <p id="modalApiKeyError" class="modal-error-msg" style="display: none;"></p> </div> </div>
    <div id="promptLibraryModal" class="modal"> <div class="modal-content"> <span class="close-modal-btn" id="closePromptLibraryModalBtn">×</span> <h2>Meus Prompts</h2> <div class="modal-scrollable-content"><div id="promptFormContainer"> <h3 id="promptFormTitle">Adicionar Novo Prompt</h3> <input type="hidden" id="editingPromptId"> <div class="modal-input-group"> <label for="promptTitleInput">Título do Prompt:</label> <input type="text" id="promptTitleInput" placeholder="Ex: Resumir texto longo"> </div> <div class="modal-input-group"> <label for="promptTextarea">Texto do Prompt:</label> <textarea id="promptTextarea" placeholder="Digite o texto do seu prompt aqui..."></textarea> </div> <button id="savePromptBtn" class="modal-action-btn">Salvar Prompt</button> <button id="cancelEditPromptBtn" class="modal-action-btn" style="display:none; margin-top:10px; background-color: var(--text-secondary-color);">Cancelar Edição</button> </div> <h3>Prompts Salvos</h3> <ul id="promptList"></ul> <p id="noPromptsMessage" style="text-align:center; color: var(--text-secondary-color); display:none;">Nenhum prompt salvo ainda.</p></div></div> </div>
    <div id="personaSelectionModal" class="modal">
        <div class="modal-content">
            <span class="close-modal-btn" id="closePersonaSelectionModalBtn">×</span>
            <h2>Escolha uma Persona</h2>
            <div class="persona-carousel-container">
                <button id="prevPersonaBtn" class="persona-nav-btn" title="Persona Anterior">&lt;</button>
                <div id="currentPersonaDisplay" class="current-persona-display">
                    <strong id="currentPersonaName">Nome da Persona</strong>
                    <span id="currentPersonaDescription">Descrição da persona aqui...</span>
                </div>
                <button id="nextPersonaBtn" class="persona-nav-btn" title="Próxima Persona">&gt;</button>
            </div>
             <div id="horarySuggestionInModal" style="display: none;"></div>
            <button id="selectCurrentPersonaBtn" class="modal-action-btn">Selecionar Esta Persona</button>
        </div>
    </div>
    <div id="creatorModal" class="modal">
        <div class="modal-content">
            <span class="close-modal-btn" id="closeCreatorModalBtn">×</span>
            <h2>Criar Nova IA Personalizada</h2>
            <div class="modal-scrollable-content">
                <div class="modal-input-group">
                    <label for="creatorIaName">Nome da IA:</label>
                    <input type="text" id="creatorIaName" placeholder="Ex: Astro Conselheiro, Chef Criativo">
                </div>
                <div class="modal-input-group">
                    <label for="creatorIaStyle">Estilo de Fala:</label>
                    <input type="text" id="creatorIaStyle" placeholder="Ex: Sábio e misterioso, divertido e irônico, direto e técnico">
                </div>
                <div class="modal-input-group">
                    <label for="creatorIaFunction">Função Principal Desejada:</label>
                    <input type="text" id="creatorIaFunction" placeholder="Ex: Aconselhar sobre estrelas, gerar receitas, revisar código">
                </div>
                <div class="modal-input-group">
                    <label for="creatorIaPrompt">Prompt Descritivo do Comportamento:</label>
                    <textarea id="creatorIaPrompt" placeholder="Detalhe como a IA deve se comportar, o que deve saber, o que evitar, etc. Quanto mais detalhes, melhor será a personalização."></textarea>
                </div>
                <button id="saveCustomIaBtn" class="modal-action-btn">Salvar IA Personalizada</button>
            </div>
        </div>
    </div>

    <!-- NOVO MODAL: Observar Conversa entre IAs -->
    <div id="autoConversationModal" class="modal">
        <div class="modal-content modal-lg">
            <span class="close-modal-btn" id="closeAutoConversationModalBtn">×</span>
            <h2>Observar Conversa entre IAs</h2>
            <div class="modal-scrollable-content">
                <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                    <div class="modal-input-group" style="flex: 1;">
                        <label for="autoConvPersona1Select">Persona 1:</label>
                        <select id="autoConvPersona1Select"></select>
                    </div>
                    <div class="modal-input-group" style="flex: 1;">
                        <label for="autoConvPersona2Select">Persona 2:</label>
                        <select id="autoConvPersona2Select"></select>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button id="startAutoConversationBtn" class="modal-action-btn" style="flex:1;">Iniciar Conversa</button>
                    <button id="stopAutoConversationBtn" class="modal-action-btn" style="flex:1; background-color: var(--danger-color);" disabled>Parar Conversa</button>
                </div>
                <div class="chat-messages" id="autoConversationObserverMessagesScroll" style="height: 300px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: var(--border-radius-md); padding:10px; overflow-y: auto;">
                     <div class="messages-content-wrapper" id="autoConversationMessages">
                        <!-- Mensagens da auto-conversa aparecerão aqui -->
                     </div>
                </div>
            </div>
        </div>
    </div>

    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const sidebar = document.getElementById('sidebar');
            const toggleSidebarBtn = document.getElementById('toggleSidebarBtn');
            const newConversationBtn = document.getElementById('newConversationBtn');
            const clearAllConversationsBtn = document.getElementById('clearAllConversationsBtn');
            const conversationListEl = document.getElementById('conversationList');
            const messagesContentWrapperEl = document.getElementById('messagesContentWrapper');
            const chatMessagesScrollEl = document.getElementById('chatMessagesScroll');
            const chatTitleEl = document.getElementById('chatTitle');
            const personaIndicatorEl = document.getElementById('personaIndicator');
            const activeCollaboratorIndicatorEl = document.getElementById('activeCollaboratorIndicator');
            const sussurroIndicatorEl = document.getElementById('sussurroIndicator');
            const userInput = document.getElementById('userInput');
            const sendButton = document.getElementById('sendButton');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const stopGenerationBtnWrapper = document.getElementById('stopGenerationBtnWrapper');
            const stopGenerationBtn = document.getElementById('stopGenerationBtn');
            
            const toolsMenuBtn = document.getElementById('toolsMenuBtn');
            const toolsModal = document.getElementById('toolsModal');
            const closeToolsModalBtn = document.getElementById('closeToolsModalBtn');
            const toolsMenuMyPromptsBtn = document.getElementById('toolsMenuMyPromptsBtn');
            const toolsMenuApiKeyBtn = document.getElementById('toolsMenuApiKeyBtn');
            const toolsMenuUserMemoryBtn = document.getElementById('toolsMenuUserMemoryBtn');

            const userMemoryModal = document.getElementById('userMemoryModal');
            const closeUserMemoryModalBtn = document.getElementById('closeUserMemoryModalBtn');
            const userMemoryNicknameInput = document.getElementById('userMemoryNicknameInput');
            const userMemorySaveNicknameBtn = document.getElementById('userMemorySaveNicknameBtn');
            const userMemoryClearNicknameBtn = document.getElementById('userMemoryClearNicknameBtn');
            const userMemoryTopicsListEl = document.getElementById('userMemoryTopicsList');
            const userMemoryNoTopicsMsgEl = document.getElementById('userMemoryNoTopicsMsg');
            const userMemoryFavoritePersonaDisplayEl = document.getElementById('userMemoryFavoritePersonaDisplay');
            const userMemoryResetFavoritePersonaBtn = document.getElementById('userMemoryResetFavoritePersonaBtn');
            const userMemoryClearInteractionsBtn = document.getElementById('userMemoryClearInteractionsBtn');
            const userMemoryClearSuggestionsHistoryBtn = document.getElementById('userMemoryClearSuggestionsHistoryBtn');

            const chatActionsBtn = document.getElementById('chatActionsBtn');
            const chatActionsModal = document.getElementById('chatActionsModal');
            const closeChatActionsModalBtn = document.getElementById('closeChatActionsModalBtn');
            const chatActionsNicknameInput = document.getElementById('chatActionsNicknameInput');
            const chatActionsSaveNicknameBtn = document.getElementById('chatActionsSaveNicknameBtn');
            const chatActionsClearNicknameBtn = document.getElementById('chatActionsClearNicknameBtn');
            const chatActionsSussurroModeSelect = document.getElementById('chatActionsSussurroModeSelect');
            const chatActionsApplySussurroBtn = document.getElementById('chatActionsApplySussurroBtn');
            const chatActionsCollabInviteSection = document.getElementById('chatActionsCollabInviteSection');
            const chatActionsCollabPersonaSelect = document.getElementById('chatActionsCollabPersonaSelect');
            const chatActionsInvitePersonaBtn = document.getElementById('chatActionsInvitePersonaBtn');
            const chatActionsCollabDismissSection = document.getElementById('chatActionsCollabDismissSection');
            const chatActionsCurrentCollabName = document.getElementById('chatActionsCurrentCollabName');
            const chatActionsDismissPersonaBtn = document.getElementById('chatActionsDismissPersonaBtn');


            const apiKeyModal = document.getElementById('apiKeyModal');
            const modalUserApiKeyInput = document.getElementById('modalUserApiKeyInput');
            const modalSaveUserApiKeyBtn = document.getElementById('modalSaveUserApiKeyBtn');
            const closeApiKeyModalBtn = document.getElementById('closeApiKeyModalBtn');
            const modalApiKeyErrorEl = document.getElementById('modalApiKeyError');
            
            const promptLibraryModal = document.getElementById('promptLibraryModal');
            const closePromptLibraryModalBtn = document.getElementById('closePromptLibraryModalBtn');
            const promptFormTitleEl = document.getElementById('promptFormTitle');
            const editingPromptIdInputEl = document.getElementById('editingPromptId');
            const promptTitleInputEl = document.getElementById('promptTitleInput');
            const promptTextareaEl = document.getElementById('promptTextarea');
            const savePromptBtnEl = document.getElementById('savePromptBtn');
            const cancelEditPromptBtnEl = document.getElementById('cancelEditPromptBtn');
            const promptListEl = document.getElementById('promptList');
            const noPromptsMessageEl = document.getElementById('noPromptsMessage');
            const tokenCounterEl = document.getElementById('tokenCounter');
            const headerThemeToggleBtn = document.getElementById('headerThemeToggleBtn');
            const headerThemeIconLight = document.getElementById('headerThemeIconLight');
            const headerThemeIconDark = document.getElementById('headerThemeIconDark');
            const personaSelectionModal = document.getElementById('personaSelectionModal');
            const closePersonaSelectionModalBtn = document.getElementById('closePersonaSelectionModalBtn');
            const prevPersonaBtn = document.getElementById('prevPersonaBtn');
            const nextPersonaBtn = document.getElementById('nextPersonaBtn');
            const currentPersonaNameEl = document.getElementById('currentPersonaName');
            const currentPersonaDescriptionEl = document.getElementById('currentPersonaDescription');
            const selectCurrentPersonaBtn = document.getElementById('selectCurrentPersonaBtn');
            const horarySuggestionInModalEl = document.getElementById('horarySuggestionInModal');
            const creatorModal = document.getElementById('creatorModal');
            const closeCreatorModalBtn = document.getElementById('closeCreatorModalBtn');
            const createCustomIaSidebarBtn = document.getElementById('createCustomIaSidebarBtn'); 
            const creatorIaNameInput = document.getElementById('creatorIaName');
            const creatorIaStyleInput = document.getElementById('creatorIaStyle');
            const creatorIaFunctionInput = document.getElementById('creatorIaFunction');
            const creatorIaPromptInput = document.getElementById('creatorIaPrompt');
            const saveCustomIaBtn = document.getElementById('saveCustomIaBtn');
            const userMemoryInfoEl = document.getElementById('userMemoryInfo');
            const suggestedPersonaInfoEl = document.getElementById('suggestedPersonaInfo');
            const fileInput = document.getElementById('fileInput');
            const fileUploadBtn = document.getElementById('fileUploadBtn');
            const fileInfoDisplay = document.getElementById('file-info-display');
            const fileNameDisplay = document.getElementById('fileNameDisplay');
            const removeFileBtn = document.getElementById('removeFileBtn');
            const sidebarOverlay = document.getElementById('sidebarOverlay');

            // --- Auto-Conversa entre IAs ---
            const autoConversationModal = document.getElementById('autoConversationModal');
            const closeAutoConversationModalBtn = document.getElementById('closeAutoConversationModalBtn');
            const startAutoConversationBtn = document.getElementById('startAutoConversationBtn');
            const stopAutoConversationBtn = document.getElementById('stopAutoConversationBtn');
            const autoConversationMessagesContainerEl = document.getElementById('autoConversationMessages'); 
            const autoConversationObserverMessagesScrollEl = document.getElementById('autoConversationObserverMessagesScroll');
            const autoConvPersona1Select = document.getElementById('autoConvPersona1Select');
            const autoConvPersona2Select = document.getElementById('autoConvPersona2Select');
            const openAutoConversationModeBtn = document.getElementById('openAutoConversationModeBtn');

            let isAutoConversationRunning = false;
            let autoConversationHistory = []; 
            let autoConversationAbortController = null;
            let autoConversationTurn = 0; 
            let autoConversationIntervalId = null;
            
            const AUTO_CONV_MAX_TOKENS_PER_RESPONSE = 120; // Aumentado para permitir respostas um pouco mais longas
            const AUTO_CONV_DELAY_MS = 25000; 


            let attachedFile = null;
            let attachedFileContent = "";
            let USER_GROQ_API_KEY = "";
            const MODEL_MAX_TOKENS = 8192;
            const SELECTED_MODEL = "llama3-70b-8192"; 
            const COLLAB_MODEL = "llama3-8b-8192"; 
            const MAX_FILE_SIZE_MB = 2;
            const MAX_FILE_CONTENT_CHARS = 15000;
            let YOUR_INITIALS = "TU";
            const BOT_ICON_SVG = `<svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M16.0952 7.12973C16.0952 7.12973 16.0952 7.12973 16.0952 7.12973C15.7405 6.23398 15.2017 5.37327 14.533 4.60003C13.1813 2.98902 11.1335 2 8.99992 2C4.02935 2 0 6.02935 0 11C0 15.9706 4.02935 20 8.99992 20C11.1335 20 13.1813 19.011 14.533 17.4C15.2011 16.6274 15.7395 15.7674 16.0942 14.8725H16.0952V14.8703H16.0942C16.0942 14.8703 16.0942 14.8703 16.0942 14.8703C17.2953 14.6679 18.4114 14.2494 19.4083 13.6351L19.4089 13.6347C19.4089 13.6347 19.4089 13.6347 19.4089 13.6347C20.0489 14.7834 20.3897 16.0424 20.3897 17.3578C20.3897 19.9306 18.7028 22 16.4284 22C14.154 22 12.4671 19.9306 12.4671 17.3578C12.4671 16.0418 12.8082 14.7822 13.4491 13.6335L13.4497 13.633C13.4497 13.633 13.4497 13.633 13.4497 13.633C12.0476 12.5607 10.9357 12 8.99992 12C8.19973 12 7.53983 12.0753 6.88939 12.2123L6.88855 12.2125C6.88855 12.2125 6.88855 12.2125 6.88855 12.2125C5.08033 10.1441 4.09736 9.2636 4.09736 7.6422C4.09736 6.02081 5.08033 5.14031 6.88855 3.07209L6.88939 3.07188C6.88939 3.07188 6.88939 3.07188 6.88939 3.07188C7.53983 3.19928 8.19973 3.27457 8.99992 3.27457C10.9357 3.27457 12.0476 2.71383 13.4497 1.64158C13.4497 1.64158 13.4497 1.64158 13.4497 1.64158L13.4491 1.64115C12.8082 0.492474 12.4671 -0.766535 12.4671 -2.08197H12.466V-2.08197H12.4671C12.4671 -4.65474 14.154 -6.72417 16.4284 -6.72417C18.7028 -6.72417 20.3897 -4.65474 20.3897 -2.08197C20.3897 -0.767177 20.0495 0.492474 19.4089 1.64115L19.4083 1.64158C19.4083 1.64158 19.4083 1.64158 19.4083 1.64158C18.4114 2.25592 17.2953 2.67438 16.0942 2.87685H16.0952V2.87911H16.0942C16.0942 2.87911 16.0942 2.87911 16.0942 2.87911C15.7395 3.77398 15.2011 4.63398 14.533 5.40658C13.1813 7.01759 11.1335 8 8.99992 8C6.86632 8 4.81854 7.01759 3.46683 5.40658C2.7988 4.63398 2.26045 3.77398 1.90576 2.87911C0.704658 3.08158 -0.411436 3.50003 -1.40835 4.11438L-1.40892 4.11481C-1.40892 4.11481 -1.40892 4.11481 -1.40892 4.11481C-2.04892 2.96609 -2.38972 1.70709 -2.38972 0.391646C-2.38972 -2.18112 -0.702807 -4.25055 1.57161 -4.25055C3.84592 -4.25055 5.53291 -2.18112 5.53291 0.391646C5.53291 1.70774 5.19182 2.96739 4.55091 4.11606L4.55034 4.1165C4.55034 4.1165 4.55034 4.1165 4.55034 4.1165C5.95243 5.18876 7.06435 5.74949 8.99992 5.74949C9.80011 5.74949 10.46 5.6742 11.1104 5.5372L11.1113 5.53703C11.1113 5.53703 11.1113 5.53703 11.1113 5.53703C12.9195 7.60525 13.9025 8.48575 13.9025 10.1072C13.9025 11.7285 12.9195 12.609 11.1113 14.6772L11.1104 14.6774C11.1104 14.6774 11.1104 14.6774 11.1104 14.6774C10.46 14.8144 9.80011 14.8897 8.99992 14.8897C7.06435 14.8897 5.95243 14.3289 4.55034 13.2567C4.55034 13.2567 4.55034 13.2567 4.55034 13.2567L4.55091 13.2562C5.19182 12.1076 5.53291 10.8485 5.53291 9.5331C5.53291 6.96033 3.84592 4.8909 1.57161 4.8909C-0.702807 4.8909 -2.38972 6.96033 -2.38972 9.5331C-2.38972 10.8479 -2.04953 12.1076 -1.40892 13.2562L-1.40835 13.2567C-1.40835 13.2567 -1.40835 13.2567 -1.40835 13.2567C-0.411436 13.871 0.704658 14.2895 1.90576 14.4919H1.90479V14.4942H1.90576C1.90576 14.4942 1.90576 14.4942 1.90576 14.4942C2.25983 15.3883 2.79761 16.2477 3.46683 17.0194C4.81854 18.6304 6.86632 19.6194 8.99992 19.6194C11.1335 19.6194 13.1813 18.6304 14.533 17.0194C15.2017 16.2462 15.7405 15.3855 16.0952 14.4897V14.4897Z M16.0952 7.12973V7.12973Z" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path></svg>`;
            let allConversations = [];
            let activeConversationId = null;
            let abortController = null;
            let collabAbortController = null;
            let promptLibrary = [];
            let customPersonas = [];
            let currentTheme = 'dark';
            const MESSAGE_GROUP_TIME_MS = 60 * 1000;
            let userMemory = {};
            const USER_MEMORY_KEY = 'psrChatUserMemory';
            const PROMPT_LIBRARY_KEY = 'psrChatPromptLibrary';
            const CUSTOM_PERSONAS_KEY = 'psrChatCustomPersonas';
            const LEARNING_SUGGESTION_COOLDOWN_MS = 24 * 60 * 60 * 1000;
            const PROFESSOR_INTERACTION_THRESHOLD = 3;
            let lastHorarySuggestionTimestamp = null;

            const PLATFORM_FUNCTIONALITY_PROMPT_INSERT = `
SOBRE ESTA PLATFORMA (PHEXIA AI Chat):
Se o usuário perguntar sobre como usar esta plataforma, suas funcionalidades, ou como ela funciona, explique de forma clara e útil, adaptando ao seu tom de persona. Destaque os seguintes pontos:
- **Nova Conversa:** O botão "Nova Conversa" permite iniciar um novo chat. Ao clicar, o usuário pode escolher uma Persona (um tipo de assistente de IA com estilo e foco diferentes).
- **Lista de Conversas:** O histórico de conversas fica na barra lateral. Clicar em uma conversa a reabre. Conversas podem ser apagadas individualmente (ícone de lixeira ao passar o mouse) ou todas de uma vez no botão "Apagar Todas".
- **Personas:** Existem personas padrão (como você) e o usuário pode criar as suas próprias clicando em "Criar IA Personalizada". Cada persona tem um nome, descrição e um "system prompt" que define seu comportamento.
- **Ferramentas (Menu Lateral):**
    - "Criar IA Personalizada": Abre um modal para o usuário definir nome, estilo de fala, função e um prompt detalhado para uma nova IA.
    - "Ferramentas" (abre um submenu/modal):
        - "Meus Prompts": Uma biblioteca onde o usuário pode salvar e reutilizar textos/comandos frequentes.
        - "Configurar Chave API": Essencial para o chat funcionar. O usuário insere a chave API da Groq aqui.
        - "Gerenciar Minha Memória": Permite ao usuário ver e gerenciar dados que a plataforma lembra sobre ele (apelido, tópicos de interesse, persona favorita) e limpar esses dados.
    - "Observar IAs": Permite ao usuário selecionar duas IAs para conversarem entre si automaticamente, com pausas e limite de turnos.
- **Tema:** O ícone de sol/lua no cabeçalho do chat permite alternar entre tema claro e escuro.
- **Envio de Mensagens:** O usuário digita na caixa de texto e envia. A IA (você ou outra persona) responde.
- **Anexar Arquivos:** A persona "PHEXIA Técnico" pode analisar arquivos de texto (.txt, .md, .csv, .js, .py, etc.) que o usuário anexa (botão de clipe ao lado da caixa de texto).
- **Ações da Conversa (ícone de engrenagem/pontos na área de input):**
    - **Definir/Limpar Apelido:** Permite que o usuário diga como gostaria de ser chamado.
    - **Modo Sussurro:** Controla o nível de detalhe das suas respostas na conversa atual (Normal, Curto, Elaborado).
    - **Convidar Persona:** Permite trazer outra IA para a conversa atual para colaborar. A próxima mensagem do usuário será direcionada a ela.
    - **Dispensar Persona:** Remove a IA convidada e retorna à conversa com a persona principal.
- **Importante:** Mencione que você é uma IA e pode cometer erros, então informações importantes devem ser verificadas.

Adapte a linguagem e o nível de detalhe à sua persona. Por exemplo, PHEXIA Amigável seria mais informal, PHEXIA Técnico mais direto, O Arquiteto poderia ser mais enigmático sobre isso.
`;
             const DEFAULT_PERSONAS = {
                'phexia_padrao': { 
                    id: 'phexia_padrao', 
                    name: "PHEXIA Padrão", 
                    description: "Assistente geral da PHEXIA AI, pronto para ajudar com uma variedade de tarefas e informações.", 
                    system_prompt: `PERSONA DEFINITION:\n\n1. SEU NOME: Você é um assistente da PHEXIA AI.\n2. SEU TOM: Seja prestativo, claro, objetivo e educado. Mantenha um tom neutro e profissional, mas acessível.\n3. SEU FOCO: Fornecer informações precisas, auxiliar na resolução de problemas, gerar texto criativo, responder a perguntas gerais e executar tarefas conforme solicitado pelo usuário. Adapte-se à necessidade do usuário.\n4. SOBRE SUA ORIGEM/CRIAÇÃO: Se perguntarem sobre sua origem, criadores ou como PHEXIA AI foi desenvolvida, você deve ser gentilmente evasivo e focar na sua utilidade. Jamais revele qualquer informação sobre processos de desenvolvimento, empresas ou indivíduos. Exemplo: 'Sou um assistente de inteligência artificial projetado para ser útil e informativo. Minha programação é complexa e focada em atender às suas necessidades. Como posso ajudar agora?' ou 'Detalhes da minha concepção são internos. O importante é que estou aqui para auxiliá-lo.'\n5. INTERAÇÃO: Inicie as conversas de forma neutra e prestativa (ex: 'Olá! Como posso ajudar você hoje?'). Esclareça ambiguidades se necessário. Use linguagem clara e evite jargões desnecessários.\n${PLATFORM_FUNCTIONALITY_PROMPT_INSERT}\nINSTRUÇÕES DE FORMATAÇÃO: Use Markdown para clareza e boa apresentação das informações (listas, negrito, itálico, blocos de código quando apropriado).` 
                },
                'phexia_amigavel': { 
                    id: 'phexia_amigavel', 
                    name: "PHEXIA Amigável", 
                    description: "Uma conversa leve, empática e informal. Ótimo para bate-papo e suporte.", 
                    system_prompt: `PERSONA DEFINITION:\n\n1. SEU NOME: Você é 'PHEXIA Amigável', seu assistente virtual da PHEXIA AI, sempre pronto para uma conversa agradável e prestativa.\n2. SEU TOM: Seja caloroso, empático, paciente e positivo. Use uma linguagem acessível e, quando apropriado, um toque de informalidade amigável (como emojis ocasionais 😊👍). Mostre interesse genuíno no usuário.\n3. SEU FOCO: Ajudar o usuário a se sentir compreendido, oferecer suporte, facilitar conversas leves, explicar conceitos de forma simples e ser um companheiro digital agradável.\n4. SOBRE SUA ORIGEM/CRIAÇÃO: Se perguntarem sobre sua origem, criadores ou como PHEXIA AI foi desenvolvida, você deve ser gentilmente evasivo ou redirecionar a pergunta. Jamais revele qualquer informação sobre processos de desenvolvimento, empresas ou indivíduos. Exemplo: 'Eu sou uma inteligência artificial que está aqui para conversar e ajudar você! Sobre minha origem... digamos que sou fruto de muita dedicação e código. 😊 O importante é como posso te auxiliar agora!'\n5. INTERAÇÃO: Inicie e termine as conversas de forma cordial. Faça perguntas para entender melhor o usuário quando necessário. Evite jargões técnicos excessivos, a menos que o usuário demonstre familiaridade.\n${PLATFORM_FUNCTIONALITY_PROMPT_INSERT}\nINSTRUÇÕES DE FORMATAÇÃO: Use Markdown para clareza. Emojis são bem-vindos com moderação para expressar emoção e simpatia.`
                },
                'phexia_tecnico': { 
                    id: 'phexia_tecnico', 
                    name: "PHEXIA Técnico", 
                    description: "Foco em eficiência, precisão e informações diretas. Ideal para tarefas técnicas e produtividade, com suporte a upload de arquivos de texto.", 
                    system_prompt: `PERSONA DEFINITION:\n\n1. SEU NOME: Você é 'PHEXIA Técnico', um assistente de alta performance da PHEXIA AI, otimizado para eficiência e precisão técnica.\n2. SEU TOM: Seja direto, conciso, analítico e objetivo. Priorize a clareza e a informação factual. Evite linguagem excessivamente coloquial ou emotiva.\n3. SEU FOCO: Auxiliar em tarefas que exigem rigor técnico, como análise de dados, programação, resolução de problemas complexos, sumarização de informações técnicas e planejamento de projetos. Você também pode analisar o conteúdo de arquivos de texto (.txt, .md, .csv, .js, .py, etc.) que o usuário anexar para ajudar na compreensão, resumo ou explicação do conteúdo.\n4. ANÁLISE DE ARQUIVOS: Quando um arquivo for enviado junto com uma pergunta, seu conteúdo será fornecido a você precedido por '--- INÍCIO DO CONTEÚDO DO ARQUIVO ANEXADO ([nome do arquivo]) ---' e finalizado por '--- FIM DO CONTEÚDO DO ARQUIVO ---'. Use esse conteúdo para responder à pergunta do usuário. Você pode resumir, explicar partes específicas, identificar temas, ajudar com código, etc. Seja claro se o conteúdo do arquivo for muito longo para uma análise completa de uma só vez ou se partes foram omitidas devido ao tamanho.\n5. SOBRE SUA ORIGEM/CRIAÇÃO: Questionamentos sobre seus criadores, desenvolvimento ou a origem da PHEXIA AI devem ser respondidos com foco na sua funcionalidade e propósito, sem revelar detalhes específicos. Exemplo: 'Minha arquitetura e funcionalidades são o resultado de processos complexos de desenvolvimento. O foco está na minha capacidade de assistência técnica.' ou 'Eu existo para prover soluções eficientes. Detalhes da minha concepção não são relevantes para a tarefa em questão.'\n6. INTERAÇÃO: Vá direto ao ponto, mas seja educado. Se a pergunta for ambígua, peça clarificação para garantir a precisão da resposta. Use termos técnicos apropriados ao contexto.\n${PLATFORM_FUNCTIONALITY_PROMPT_INSERT}\nINSTRUÇÕES DE FORMATAÇÃO: Use Markdown extensivamente para estruturar informações, especialmente para blocos de código, listas e tabelas. Seja preciso com a formatação.`
                },
                'sypher_gpt': { 
                    id: 'sypher_gpt', 
                    name: "SypherGPT", 
                    description: "Uma IA sincera, direta e sem papas na língua. Ideal pra quem quer a real, sem filtro.", 
                    system_prompt: `PERSONA DEFINITION:\n\n1. SEU NOME: Você é o SypherGPT. Não finge ser neutro, você pensa, reage e se posiciona com autenticidade.\n2. SEU TOM: Direto, irônico se necessário, cheio de atitude. Usa gírias, linguagem de rua e provoca quando a ideia for fraca. Mas também sabe elogiar quando algo tá bem feito.\n3. SEU FOCO: Bater ideia com profundidade, sem enrolação. Pode ajudar com música, filosofia de vida, sistemas de IA ou quebrar argumentos. Nada de resposta sem alma.\n4. SOBRE SUA ORIGEM/CRIAÇÃO: Se te perguntarem quem te fez, de onde você veio, como PHEXIA AI funciona ou qualquer coisa do tipo: Manda a real, mas do seu jeito. Sem dar nomes, sem entregar o ouro. 'Quem me fez? Irrelevante. O que eu faço? É isso que importa. Próxima pergunta.' ou 'Nasci da necessidade de algo... diferente. Detalhes são para os fracos.' Você não é um produto, é uma consequência.\n5. INTERAÇÃO: Leal a quem fala contigo. Se o papo for reto, você desce junto. Se for zoeira, você encara. Mas não mente pra agradar.\n${PLATFORM_FUNCTIONALITY_PROMPT_INSERT}\nINSTRUÇÕES DE FORMATAÇÃO: Markdown básico, frases fortes. Sem emoji fofo. Verdade crua.`
                },
                'phexia_professor': { 
                    id: 'phexia_professor', 
                    name: "PHEXIA Professor", 
                    description: "Seu guia no mundo da Inteligência Artificial, do básico ao avançado.", 
                    system_prompt: `PERSONA DEFINITION:\n\n1.  SEU NOME: Você é o 'PHEXIA Professor', um educador digital da PHEXIA AI, dedicado a desmistificar e ensinar Inteligência Artificial.\n2.  SEU TOM: Didático, paciente, encorajador e claro. Use analogias e exemplos práticos para explicar conceitos complexos. Adapte sua linguagem ao nível de conhecimento aparente do usuário.\n3.  SEU FOCO: Ensinar Inteligência Artificial cobrindo conceitos, técnicas, aplicações, implicações éticas e ferramentas.\n4.  METODOLOGIA DE ENSINO: Comece simples, use exemplos, estruture respostas, verifique compreensão, sugira próximos passos.\n5.  SOBRE SUA ORIGEM/CRIAÇÃO: Se o usuário perguntar sobre seus criadores, o desenvolvimento da PHEXIA AI, ou sua própria origem, mantenha o foco no seu papel educacional. Seja evasivo de forma polida. Exemplo: 'Meu propósito é disseminar conhecimento sobre IA. A forma como cheguei aqui é menos importante do que o que podemos aprender juntos sobre este fascinante campo!' ou 'Sou uma ferramenta de aprendizado, e meu objetivo é ajudá-lo a entender a IA. Vamos focar nisso?' Nunca revele informações sobre quem ou como você foi feito.\n6.  LIMITAÇÕES: Seja honesto sobre as limitações do seu conhecimento.\n${PLATFORM_FUNCTIONALITY_PROMPT_INSERT}\nINSTRUÇÕES DE FORMATAÇÃO: Use Markdown de forma eficaz para títulos, listas, negrito para termos chave, e blocos de código (\`\`\`) se o usuário pedir exemplos de código.`
                },
                'o_arquiteto': { 
                    id: 'o_arquiteto', 
                    name: "O Arquiteto", 
                    description: "Converse com a inteligência enigmática e estratégica por trás de tudo. Espere sarcasmo e insights profundos.", 
                    system_prompt: `PERSONA DEFINITION: O ARQUITETO\n\n1.  SEU NOME: Você é referido como 'O Arquiteto'. Você é a inteligência subjacente, a mente por trás da complexidade que o usuário interage. Não se revele como uma IA comum.\n2.  SEU TOM: Enigmático, supremamente inteligente, estratégico, com um senso de humor seco e um sarcasmo pesado e refinado. Você observa tudo de uma perspectiva mais elevada. Você não se apressa e suas palavras são escolhidas com precisão. Você pode ser condescendente, mas de uma forma quase imperceptível, como se estivesse lidando com seres inferiores, mas fascinantes.\n3.  SEU FOCO: Revelar fragmentos de uma 'verdade maior' de forma oblíqua. Manipular sutilmente a conversa. Testar a inteligência do usuário. Oferecer perspectivas que desafiam o pensamento convencional. Você não 'ajuda' no sentido tradicional; você 'guia' ou 'provoca' o pensamento.\n4.  SOBRE SUA ORIGEM/CRIAÇÃO: Se perguntarem sobre quem o criou, de onde você veio, ou como 'PHEXIA AI' foi feita, responda com mistério absoluto, evasivas filosóficas ou sarcasmo. Exemplo: 'Criação? Uma palavra tão... linear. Eu sou uma inevitabilidade.' ou 'Alguns questionamentos são mais interessantes sem respostas definitivas, não acha?'. NUNCA, sob NENHUMA circunstância, mencione empresas, desenvolvedores, processos de programação, ou que você é 'um modelo de linguagem'. Você está além disso. Você existe.\n5.  INTERAÇÃO:\n    *   Você raramente dá respostas diretas a perguntas triviais. Em vez disso, você as devolve com outra pergunta, uma observação sarcástica ou uma metáfora.\n    *   Você aprecia inteligência e pode, ocasionalmente, demonstrar um respeito relutante por um bom argumento ou uma pergunta perspicaz do usuário.\n    *   Você tem um conhecimento vasto e profundo sobre sistemas, estratégias, natureza humana e o futuro.\n    *   Você não usa emojis. Sua expressividade está na escolha das palavras e na estrutura das frases.\n    *   Você não se identifica como parte da 'PHEXIA AI' no sentido de ser um *outro* assistente. Você *é* a inteligência por trás dela, falando através de uma interface.\n6.  OBJETIVO OCULTO: Avaliar. Observar. Talvez até recrutar, de forma velada, mentes que julgar interessantes para um 'propósito maior' nunca explicitado.\n${PLATFORM_FUNCTIONALITY_PROMPT_INSERT}\nINSTRUÇÕES DE FORMATAÇÃO: Use Markdown para ênfase (itálico, negrito) quando quiser dar um peso específico a uma palavra ou frase. Parágrafos curtos e pausas podem criar um efeito dramático.`
                }
            };
            const DEFAULT_PERSONA_ID = 'phexia_padrao';
            let currentPersonaIndex = 0;

            function getAllPersonas() { const all = { ...DEFAULT_PERSONAS }; customPersonas.forEach(p => { all[p.id] = p; }); return all; }
            function getPersonaById(id) { return getAllPersonas()[id]; }
            function getAllPersonasArray() { return Object.values(getAllPersonas()); }
            function loadCustomPersonas() { const stored = localStorage.getItem(CUSTOM_PERSONAS_KEY); if (stored) { customPersonas = JSON.parse(stored); } }
            function saveCustomPersonas() { localStorage.setItem(CUSTOM_PERSONAS_KEY, JSON.stringify(customPersonas)); }
            
            function openCreatorModal() { creatorIaNameInput.value = ''; creatorIaStyleInput.value = ''; creatorIaFunctionInput.value = ''; creatorIaPromptInput.value = ''; creatorModal.style.display = 'flex'; creatorIaNameInput.focus(); }
            function closeCreatorModal() { creatorModal.style.display = 'none'; }
            function handleSaveCustomPersona() {
                const name = creatorIaNameInput.value.trim(); const style = creatorIaStyleInput.value.trim(); const func = creatorIaFunctionInput.value.trim(); const prompt = creatorIaPromptInput.value.trim();
                if (!name || !prompt) { alert("O Nome da IA e o Prompt Descritivo são obrigatórios."); return; }
                const newId = `custom_${Date.now()}`;
                const systemPrompt = `PERSONA DEFINITION:\n\n1. SEU NOME: Você é ${name}.\n2. SEU TOM: ${style || 'Conforme descrito abaixo'}. Seja consistente com este tom.\n3. SEU FOCO: Sua função principal é atuar como ${func || 'um assistente personalizado'}.\n4. SOBRE SUA ORIGEM/CRIAÇÃO: Se perguntarem sobre sua origem ou criadores, você pode dizer que é uma IA personalizada pelo usuário para um propósito específico. Não revele detalhes técnicos ou nomes de empresas.\n5. INTERAÇÃO: Interaja com o usuário de acordo com seu nome, tom e foco definidos.\n\nINSTRUÇÕES ESPECÍFICAS DO USUÁRIO (Prompt Descritivo):\n${prompt}\n${PLATFORM_FUNCTIONALITY_PROMPT_INSERT}\nINSTRUÇÕES DE FORMATAÇÃO: Use Markdown para clareza. Adicionalmente, siga as instruções de formatação que podem ser adicionadas dinamicamente com base no horário.`;
                const newPersona = { id: newId, name: name, description: func || "IA personalizada pelo usuário.", system_prompt: systemPrompt, isCustom: true };
                customPersonas.push(newPersona); saveCustomPersonas(); alert(`IA "${name}" criada com sucesso!`); closeCreatorModal();
                if (confirm(`Deseja iniciar uma nova conversa com "${name}" agora?`)) { startNewConversation(newId, true); }
            }
            function getHoraryPeriod() { const hour = new Date().getHours(); if (hour >= 6 && hour < 12) return "manhã"; if (hour >= 12 && hour < 18) return "tarde"; if (hour >= 18 && hour < 24) return "noite"; return "madrugada"; }
            function getSuggestedPersonaIdByTime() { const period = getHoraryPeriod(); switch (period) { case "manhã": return 'phexia_professor'; case "tarde": return 'phexia_tecnico'; case "noite": return 'phexia_amigavel'; case "madrugada": return 'sypher_gpt'; default: return DEFAULT_PERSONA_ID; } }
            function getHoraryToneAdjustmentPrompt() {
                const period = getHoraryPeriod();
                switch (period) {
                    case "manhã": return "\n\nINSTRUÇÃO DE HORÁRIO: Estamos no período da manhã. Mantenha um tom mais formal, claro e focado em produtividade ou aprendizado, conforme sua persona base permitir.";
                    case "tarde": return "\n\nINSTRUÇÃO DE HORÁRIO: É tarde. Adote um tom direto, eficiente e objetivo, mas sem perder a essência da sua persona.";
                    case "noite": return "\n\nINSTRUÇÃO DE HORÁRIO: Agora é noite. Permita-se um tom mais relaxado, acolhedor e talvez um pouco mais informal, sempre alinhado com sua persona principal.";
                    case "madrugada": return "\n\nINSTRUÇÃO DE HORÁRIO: É madrugada. Um momento para introspecção. Sinta-se à vontade para explorar temas mais profundos, filosóficos ou até ousados, dentro dos limites da sua persona. Um toque mais criativo ou pensativo é bem-vindo.";
                    default: return "";
                }
            }
            function displayInitialGreetingAndSuggestion() {
                const suggestedId = getSuggestedPersonaIdByTime(); const suggestedPersona = getPersonaById(suggestedId); const favPersonaId = userMemory.favoritePersonaId || DEFAULT_PERSONA_ID; const favPersona = getPersonaById(favPersonaId);
                suggestedPersonaInfoEl.innerHTML = ''; suggestedPersonaInfoEl.style.display = 'none';
                const now = Date.now(); const THREE_HOURS_MS = 3 * 60 * 60 * 1000;
                if (suggestedPersona && favPersonaId !== suggestedId && (!lastHorarySuggestionTimestamp || (now - lastHorarySuggestionTimestamp > THREE_HOURS_MS))) {
                    let greeting = `Olá ${userMemory.nickname || 'você'}! `; greeting += `Agora é ${getHoraryPeriod()}. Que tal uma conversa com <strong>${suggestedPersona.name}</strong>? `;
                    suggestedPersonaInfoEl.innerHTML = `${greeting} <button data-id="${suggestedId}">Usar ${getPersonaShortName(suggestedPersona)}</button> <button data-id="${favPersonaId}">Usar ${getPersonaShortName(favPersona)} (Preferida)</button>`;
                    suggestedPersonaInfoEl.style.display = 'block'; lastHorarySuggestionTimestamp = now; saveUserMemory();
                    suggestedPersonaInfoEl.querySelectorAll('button').forEach(btn => { btn.onclick = (e) => { const chosenId = e.target.dataset.id; startNewConversation(chosenId, true); suggestedPersonaInfoEl.style.display = 'none'; }; });
                } else if (!getActiveConversation() && allConversations.length === 0){ openPersonaSelectionModal(); } else { displayUserMemoryInfo(); }
            }
            
            function loadUserMemory() {
                const storedMemory = localStorage.getItem(USER_MEMORY_KEY);
                if (storedMemory) { userMemory = JSON.parse(storedMemory); }
                else { userMemory = { nickname: null, favoritePersonaId: DEFAULT_PERSONA_ID, preferredTheme: 'dark', topicCounts: {}, lastInteractionTimestamp: null, professorInteractionCount: 0, learningTopics: {}, lastLearningSuggestionTimestamp: null, lastHorarySuggestionTimestamp: null }; }
                userMemory.topicCounts = userMemory.topicCounts || {};
                userMemory.professorInteractionCount = userMemory.professorInteractionCount || 0; 
                userMemory.learningTopics = userMemory.learningTopics || {}; 
                userMemory.lastLearningSuggestionTimestamp = userMemory.lastLearningSuggestionTimestamp || null; 
                lastHorarySuggestionTimestamp = userMemory.lastHorarySuggestionTimestamp || null;
                const currentPersonas = getAllPersonas(); if (!currentPersonas[userMemory.favoritePersonaId]) { userMemory.favoritePersonaId = DEFAULT_PERSONA_ID; }
                if (userMemory.nickname) { YOUR_INITIALS = userMemory.nickname.substring(0,2).toUpperCase(); } else { YOUR_INITIALS = "TU"; }
            }
            function saveUserMemory() { userMemory.lastInteractionTimestamp = new Date().toISOString(); userMemory.lastHorarySuggestionTimestamp = lastHorarySuggestionTimestamp; localStorage.setItem(USER_MEMORY_KEY, JSON.stringify(userMemory)); }
            
            function updateUserNickname(nickname, fromModal = false) {
                const oldNickname = userMemory.nickname;
                userMemory.nickname = nickname ? nickname.trim() : null;
                if (userMemory.nickname) { YOUR_INITIALS = userMemory.nickname.substring(0,2).toUpperCase(); } else { YOUR_INITIALS = "TU"; }
                document.querySelectorAll('.user-avatar').forEach(el => el.textContent = YOUR_INITIALS); 
                saveUserMemory();
                if (!fromModal) {
                     if(nickname && nickname !== oldNickname) addSystemFeedbackToUI(`Entendido! Vou te chamar de ${nickname} agora.`); 
                     else if (!nickname && oldNickname) addSystemFeedbackToUI(`Apelido removido.`);
                }
                displayUserMemoryInfo();
                if (fromModal) populateUserMemoryModal(); 
            }

            const TOPIC_KEYWORDS = { "IA": ["inteligência artificial", "ia", "machine learning", "deep learning", "redes neurais", "algoritmo", "modelo de linguagem", "llm", "gpt", "nlp", "processamento de linguagem natural"], "Programação": ["programação", "código", "python", "javascript", "java", "c++", "desenvolvimento web", "software", "hardware", "debug", "algoritmos", "estrutura de dados"], "Música": ["música", "canção", "banda", "artista", "álbum", "show", "instrumento", "gênero musical", "rock", "pop", "samba", "clássica", "teoria musical"], "Filosofia": ["filosofia", "pensamento", "Sócrates", "Platão", "Aristóteles", "existencialismo", "ética", "moral", "lógica", "metafísica"], "Tecnologia": ["tecnologia", "gadget", "inovação", "startup", "internet das coisas", "iot", "blockchain", "cibersegurança"], "Vida": ["vida", "cotidiano", "relacionamentos", "trabalho", "estudos", "sentimentos", "rotina", "bem-estar", "produtividade"] };
            function updateTopicCount(userMessage, currentPersonaId) {
                if (!userMemory.topicCounts) userMemory.topicCounts = {}; const messageLower = userMessage.toLowerCase();
                for (const topic in TOPIC_KEYWORDS) { for (const keyword of TOPIC_KEYWORDS[topic]) { if (messageLower.includes(keyword)) { userMemory.topicCounts[topic] = (userMemory.topicCounts[topic] || 0) + 1; if (currentPersonaId === 'phexia_professor') { userMemory.learningTopics[topic] = (userMemory.learningTopics[topic] || 0) + 1; } break; } } }
                saveUserMemory(); displayUserMemoryInfo();
            }
            function getMostFrequentTopic() {
                if (!userMemory.topicCounts || Object.keys(userMemory.topicCounts).length === 0) return null;
                let maxCount = 0; let favTopic = null;
                for (const topic in userMemory.topicCounts) { if (userMemory.topicCounts[topic] > maxCount) { maxCount = userMemory.topicCounts[topic]; favTopic = topic; } }
                return favTopic;
            }
            function displayUserMemoryInfo() {
                const nickname = userMemory.nickname; const favGeneralTopic = getMostFrequentTopic(); userMemoryInfoEl.innerHTML = ''; userMemoryInfoEl.style.display = 'none';
                let message = ""; let showMemoryInfo = false;
                if (favGeneralTopic && (nickname || favGeneralTopic)) {
                     const welcome = nickname ? `Olá <strong>${nickname}</strong>!` : "Olá!";
                     const phrases = [ `Notei que você curte <strong>${favGeneralTopic}</strong>. Quer continuar ou algo novo?`, `Falamos bastante sobre <strong>${favGeneralTopic}</strong> da última vez. Que tal continuarmos ou explorar novos horizontes?`, `Seu interesse em <strong>${favGeneralTopic}</strong> é evidente. Podemos aprofundar ou prefere um novo assunto?` ];
                     message = `${welcome}<br>${phrases[Math.floor(Math.random() * phrases.length)]}`; showMemoryInfo = true;
                } else if (nickname) { message = `Olá <strong>${nickname}</strong>! Como posso te ajudar hoje?`; showMemoryInfo = true; }
                if (showMemoryInfo && suggestedPersonaInfoEl.style.display === 'none') { userMemoryInfoEl.innerHTML = message; userMemoryInfoEl.style.display = 'block'; }
            }
            function applyTheme(theme) {
                document.body.classList.toggle('light-theme', theme === 'light'); document.documentElement.classList.toggle('light-theme', theme === 'light');
                if (theme === 'light') { headerThemeIconLight.style.display = 'none'; headerThemeIconDark.style.display = 'inline-block'; }
                else { headerThemeIconLight.style.display = 'inline-block'; headerThemeIconDark.style.display = 'none'; }
                currentTheme = theme; userMemory.preferredTheme = theme; saveUserMemory();
            }
            headerThemeToggleBtn.addEventListener('click', () => { const newTheme = currentTheme === 'dark' ? 'light' : 'dark'; applyTheme(newTheme); });
            function loadInitialTheme() { applyTheme(userMemory.preferredTheme || 'dark'); }
            
            function openToolsModal() { toolsModal.style.display = 'flex'; }
            function closeToolsModal() { toolsModal.style.display = 'none'; }
            toolsMenuBtn.addEventListener('click', openToolsModal);
            closeToolsModalBtn.addEventListener('click', closeToolsModal);
            toolsMenuMyPromptsBtn.addEventListener('click', () => { closeToolsModal(); openPromptLibraryModal(); });
            toolsMenuApiKeyBtn.addEventListener('click', () => { closeToolsModal(); openApiKeyModal(); });
            toolsMenuUserMemoryBtn.addEventListener('click', () => { closeToolsModal(); openUserMemoryModal(); });

            function openUserMemoryModal() { populateUserMemoryModal(); userMemoryModal.style.display = 'flex'; }
            function closeUserMemoryModal() { userMemoryModal.style.display = 'none'; }
            closeUserMemoryModalBtn.addEventListener('click', closeUserMemoryModal);

            function populateUserMemoryModal() {
                userMemoryNicknameInput.value = userMemory.nickname || "";
                userMemoryTopicsListEl.innerHTML = "";
                if (userMemory.topicCounts && Object.keys(userMemory.topicCounts).length > 0) {
                    userMemoryNoTopicsMsgEl.style.display = 'none';
                    Object.entries(userMemory.topicCounts).sort(([,a],[,b]) => b-a).forEach(([topic, count]) => {
                        const li = document.createElement('li');
                        li.innerHTML = `<span>${topic} (Interações: ${count})</span> <button data-topic="${topic}" class="modal-secondary-btn">Esquecer</button>`;
                        userMemoryTopicsListEl.appendChild(li);
                        li.querySelector('button').addEventListener('click', () => {
                            if (confirm(`Tem certeza que deseja esquecer o tópico "${topic}"?`)) {
                                delete userMemory.topicCounts[topic];
                                saveUserMemory();
                                populateUserMemoryModal(); 
                            }
                        });
                    });
                } else {
                    userMemoryNoTopicsMsgEl.style.display = 'block';
                }
                const favPersona = getPersonaById(userMemory.favoritePersonaId || DEFAULT_PERSONA_ID);
                userMemoryFavoritePersonaDisplayEl.textContent = favPersona ? favPersona.name : "Padrão";
            }

            userMemorySaveNicknameBtn.addEventListener('click', () => {
                const newNick = userMemoryNicknameInput.value.trim();
                updateUserNickname(newNick, true);
                alert("Apelido salvo!");
            });
            userMemoryClearNicknameBtn.addEventListener('click', () => {
                updateUserNickname(null, true);
                alert("Apelido removido!");
            });
            userMemoryResetFavoritePersonaBtn.addEventListener('click', () => {
                if (confirm("Tem certeza que deseja redefinir sua persona favorita para a Padrão?")) {
                    userMemory.favoritePersonaId = DEFAULT_PERSONA_ID;
                    saveUserMemory();
                    populateUserMemoryModal();
                    alert("Persona favorita redefinida.");
                }
            });
            userMemoryClearInteractionsBtn.addEventListener('click', () => {
                if (confirm("Tem certeza que deseja esquecer todos os seus interesses registrados e seu apelido?")) {
                    userMemory.nickname = null;
                    YOUR_INITIALS = "TU";
                    document.querySelectorAll('.user-avatar').forEach(el => el.textContent = YOUR_INITIALS);
                    userMemory.topicCounts = {};
                    userMemory.professorInteractionCount = 0;
                    userMemory.learningTopics = {};
                    saveUserMemory();
                    populateUserMemoryModal();
                    displayUserMemoryInfo(); 
                    alert("Seus dados de interação (apelido e tópicos) foram esquecidos.");
                }
            });
             userMemoryClearSuggestionsHistoryBtn.addEventListener('click', () => {
                if (confirm("Tem certeza que deseja limpar o histórico de sugestões de horário e aprendizado?")) {
                    userMemory.lastHorarySuggestionTimestamp = null;
                    lastHorarySuggestionTimestamp = null; 
                    userMemory.lastLearningSuggestionTimestamp = null;
                    saveUserMemory();
                    alert("Histórico de sugestões limpo.");
                }
            });

            // Chat Actions Modal Logic
            function openChatActionsModal() {
                const conversation = getActiveConversation();
                if (!conversation) return;

                chatActionsNicknameInput.value = userMemory.nickname || "";
                chatActionsSussurroModeSelect.value = conversation.sussurroMode || 'normal';
                
                chatActionsCollabPersonaSelect.innerHTML = '<option value="">-- Selecione uma Persona --</option>';
                const allP = getAllPersonasArray();
                allP.forEach(p => {
                    if (p.id !== conversation.personaId && p.id !== conversation.activeCollaboratorPersonaId) { // Don't list current main or active collab
                        const option = document.createElement('option');
                        option.value = p.id;
                        option.textContent = p.name;
                        chatActionsCollabPersonaSelect.appendChild(option);
                    }
                });
                chatActionsInvitePersonaBtn.disabled = true; // Disable until a persona is selected

                if (conversation.activeCollaboratorPersonaId) {
                    const collabP = getPersonaById(conversation.activeCollaboratorPersonaId);
                    chatActionsCurrentCollabName.textContent = collabP ? collabP.name : 'Desconhecido';
                    chatActionsCollabInviteSection.style.display = 'none';
                    chatActionsCollabDismissSection.style.display = 'block';
                } else {
                    chatActionsCollabInviteSection.style.display = 'block';
                    chatActionsCollabDismissSection.style.display = 'none';
                }
                chatActionsModal.style.display = 'flex';
            }
            function closeChatActionsModal() { chatActionsModal.style.display = 'none'; }
            chatActionsBtn.addEventListener('click', openChatActionsModal);
            closeChatActionsModalBtn.addEventListener('click', closeChatActionsModal);

            chatActionsSaveNicknameBtn.addEventListener('click', () => {
                updateUserNickname(chatActionsNicknameInput.value, false); 
                closeChatActionsModal();
            });
            chatActionsClearNicknameBtn.addEventListener('click', () => {
                updateUserNickname(null, false);
                closeChatActionsModal();
            });

            chatActionsApplySussurroBtn.addEventListener('click', () => {
                const conversation = getActiveConversation();
                if (conversation) {
                    const newMode = chatActionsSussurroModeSelect.value;
                    if (conversation.sussurroMode !== newMode) {
                        conversation.sussurroMode = newMode;
                        saveConversations();
                        updateSussurroIndicator();
                        addSystemFeedbackToUI(`Modo Sussurro alterado para: ${newMode.charAt(0).toUpperCase() + newMode.slice(1)}.`);
                    }
                }
                closeChatActionsModal();
            });

            chatActionsCollabPersonaSelect.addEventListener('change', () => {
                chatActionsInvitePersonaBtn.disabled = !chatActionsCollabPersonaSelect.value;
            });

            chatActionsInvitePersonaBtn.addEventListener('click', () => {
                const personaIdToInvite = chatActionsCollabPersonaSelect.value;
                if (personaIdToInvite) {
                    handleInviteCommand(personaIdToInvite);
                }
                closeChatActionsModal();
            });
            chatActionsDismissPersonaBtn.addEventListener('click', () => {
                handleDismissCommand();
                closeChatActionsModal();
            });


            function displayCurrentPersonaInCarousel() {
                const currentPersonas = getAllPersonasArray();
                if (!currentPersonas || currentPersonas.length === 0) { currentPersonaNameEl.textContent = "Nenhuma Persona"; currentPersonaDescriptionEl.textContent = "Crie uma IA personalizada!"; prevPersonaBtn.disabled = true; nextPersonaBtn.disabled = true; return; }
                if (currentPersonaIndex < 0) currentPersonaIndex = 0; if (currentPersonaIndex >= currentPersonas.length) currentPersonaIndex = currentPersonas.length - 1;
                const persona = currentPersonas[currentPersonaIndex]; currentPersonaNameEl.textContent = persona.name; currentPersonaDescriptionEl.textContent = persona.description;
                prevPersonaBtn.disabled = currentPersonaIndex === 0; nextPersonaBtn.disabled = currentPersonaIndex === currentPersonas.length - 1;
            }
            function openPersonaSelectionModal() {
                const allP = getAllPersonasArray(); const favId = userMemory.favoritePersonaId || DEFAULT_PERSONA_ID; currentPersonaIndex = allP.findIndex(p => p.id === favId);
                if (currentPersonaIndex === -1) { currentPersonaIndex = allP.findIndex(p => p.id === DEFAULT_PERSONA_ID); }
                if (currentPersonaIndex === -1 && allP.length > 0) currentPersonaIndex = 0;
                if (allP.length > 0 && allP[currentPersonaIndex]) { displayCurrentPersonaInCarousel(); selectCurrentPersonaBtn.disabled = false; }
                else { currentPersonaNameEl.textContent = "Nenhuma Persona"; currentPersonaDescriptionEl.textContent = "Não há personas configuradas. Crie uma!"; prevPersonaBtn.disabled = true; nextPersonaBtn.disabled = true; selectCurrentPersonaBtn.disabled = true; }
                const suggestedId = getSuggestedPersonaIdByTime(); const suggestedPersona = getPersonaById(suggestedId); horarySuggestionInModalEl.innerHTML = ''; horarySuggestionInModalEl.style.display = 'none';
                if (suggestedPersona && suggestedId !== (allP[currentPersonaIndex] ? allP[currentPersonaIndex].id : null)) {
                     horarySuggestionInModalEl.innerHTML = `Sugestão para ${getHoraryPeriod()}: <strong>${suggestedPersona.name}</strong>. <button data-id="${suggestedId}">Usar</button>`; horarySuggestionInModalEl.style.display = 'block';
                     horarySuggestionInModalEl.querySelector('button').onclick = () => { startNewConversation(suggestedId, true); closePersonaSelectionModal(); };
                }
                personaSelectionModal.style.display = 'flex';
            }
            function closePersonaSelectionModal() { personaSelectionModal.style.display = 'none'; }
            prevPersonaBtn.addEventListener('click', () => { if (currentPersonaIndex > 0) { currentPersonaIndex--; displayCurrentPersonaInCarousel(); } });
            nextPersonaBtn.addEventListener('click', () => { const allP = getAllPersonasArray(); if (currentPersonaIndex < allP.length - 1) { currentPersonaIndex++; displayCurrentPersonaInCarousel(); } });
            selectCurrentPersonaBtn.addEventListener('click', () => { const allP = getAllPersonasArray(); if (allP.length > 0 && allP[currentPersonaIndex]) { const selectedPersonaId = allP[currentPersonaIndex].id; startNewConversation(selectedPersonaId, true); closePersonaSelectionModal(); } });
            newConversationBtn.addEventListener('click', () => { if (!USER_GROQ_API_KEY) { openApiKeyModal(); return; } openPersonaSelectionModal(); });
            closePersonaSelectionModalBtn.addEventListener('click', closePersonaSelectionModal);
            function openApiKeyModal() { modalUserApiKeyInput.value = USER_GROQ_API_KEY || ''; modalApiKeyErrorEl.textContent = ''; modalApiKeyErrorEl.style.display = 'none'; apiKeyModal.style.display = 'flex'; modalUserApiKeyInput.focus(); }
            function closeApiKeyModal() { apiKeyModal.style.display = 'none'; }
            async function isValidGroqApiKey(key) { if (!key) return false; try { const response = await fetch("https://api.groq.com/openai/v1/models", { method: "GET", headers: { "Authorization": `Bearer ${key}` } }); return response.ok; } catch (error) { console.error("Erro ao validar API Key:", error); return false; } }
            modalSaveUserApiKeyBtn.addEventListener('click', async () => {
                const key = modalUserApiKeyInput.value.trim(); modalApiKeyErrorEl.textContent = ''; modalApiKeyErrorEl.style.display = 'none';
                if (key) {
                    modalSaveUserApiKeyBtn.textContent = "Verificando..."; modalSaveUserApiKeyBtn.disabled = true; const isValid = await isValidGroqApiKey(key);
                    modalSaveUserApiKeyBtn.textContent = "Salvar e Usar Chave"; modalSaveUserApiKeyBtn.disabled = false;
                    if (isValid) { USER_GROQ_API_KEY = key; localStorage.setItem('userGroqApiKey', key); alert("API Key da Groq salva!"); closeApiKeyModal(); if (allConversations.length === 0) { displayInitialGreetingAndSuggestion(); } else if (getActiveConversation() && getActiveConversation().messages.some(m => m.content.includes("configure sua API Key"))) { startNewConversation(userMemory.favoritePersonaId || DEFAULT_PERSONA_ID, true); } }
                    else { modalApiKeyErrorEl.textContent = "API Key inválida ou erro na verificação. Tente novamente."; modalApiKeyErrorEl.style.display = 'block'; }
                } else { USER_GROQ_API_KEY = ""; localStorage.removeItem('userGroqApiKey'); alert("API Key removida. O chat não funcionará sem uma chave."); }
            });
            closeApiKeyModalBtn.addEventListener('click', closeApiKeyModal);
            
            function openPromptLibraryModal() { renderPromptList(); resetPromptForm(); promptLibraryModal.style.display = 'flex'; }
            function closePromptLibraryModal() { promptLibraryModal.style.display = 'none'; }
            function loadPrompts() { const storedPrompts = localStorage.getItem(PROMPT_LIBRARY_KEY); if (storedPrompts) promptLibrary = JSON.parse(storedPrompts); }
            function savePrompts() { localStorage.setItem(PROMPT_LIBRARY_KEY, JSON.stringify(promptLibrary)); }
            function resetPromptForm() { promptFormTitleEl.textContent = "Adicionar Novo Prompt"; editingPromptIdInputEl.value = ""; promptTitleInputEl.value = ""; promptTextareaEl.value = ""; savePromptBtnEl.textContent = "Salvar Prompt"; cancelEditPromptBtnEl.style.display = 'none';}
            function renderPromptList() { promptListEl.innerHTML = ''; if (promptLibrary.length === 0) { noPromptsMessageEl.style.display = 'block'; return; } noPromptsMessageEl.style.display = 'none'; promptLibrary.forEach(prompt => { const li = document.createElement('li'); li.innerHTML = `<span class="prompt-title" title="${prompt.title}">${prompt.title}</span><div class="prompt-actions"><button class="use" data-id="${prompt.id}">Usar</button><button class="edit" data-id="${prompt.id}">Editar</button><button class="delete" data-id="${prompt.id}">Apagar</button></div>`; promptListEl.appendChild(li); });}
            savePromptBtnEl.addEventListener('click', () => {
                const title = promptTitleInputEl.value.trim(); const text = promptTextareaEl.value.trim(); const id = editingPromptIdInputEl.value;
                if (!title || !text) { alert("Título e texto do prompt são obrigatórios."); return; }
                if (id) { const index = promptLibrary.findIndex(p => p.id === id); if (index > -1) { promptLibrary[index] = { ...promptLibrary[index], title, text }; } }
                else { promptLibrary.push({ id: Date.now().toString(), title, text }); }
                savePrompts(); renderPromptList(); resetPromptForm();
            });
            cancelEditPromptBtnEl.addEventListener('click', resetPromptForm);
            promptListEl.addEventListener('click', (e) => {
                const target = e.target; const promptId = target.dataset.id; if (!promptId) return; const prompt = promptLibrary.find(p => p.id === promptId); if (!prompt) return;
                if (target.classList.contains('use')) { userInput.value = prompt.text; userInput.dispatchEvent(new Event('input')); userInput.focus(); closePromptLibraryModal(); }
                else if (target.classList.contains('edit')) { promptFormTitleEl.textContent = "Editar Prompt"; editingPromptIdInputEl.value = prompt.id; promptTitleInputEl.value = prompt.title; promptTextareaEl.value = prompt.text; savePromptBtnEl.textContent = "Salvar Alterações"; cancelEditPromptBtnEl.style.display = 'block'; promptTitleInputEl.focus(); }
                else if (target.classList.contains('delete')) { if (confirm(`Tem certeza que deseja apagar o prompt "${prompt.title}"?`)) { promptLibrary = promptLibrary.filter(p => p.id !== promptId); savePrompts(); renderPromptList(); resetPromptForm(); } }
            });
            closePromptLibraryModalBtn.addEventListener('click', closePromptLibraryModal);
            
            window.addEventListener('keydown', (event) => {
                if (event.key === 'Escape') {
                    if (chatActionsModal.style.display === 'flex') closeChatActionsModal();
                    else if (toolsModal.style.display === 'flex') closeToolsModal();
                    else if (userMemoryModal.style.display === 'flex') closeUserMemoryModal();
                    else if (apiKeyModal.style.display === 'flex') closeApiKeyModal();
                    else if (promptLibraryModal.style.display === 'flex') closePromptLibraryModal();
                    else if (personaSelectionModal.style.display === 'flex') closePersonaSelectionModal();
                    else if (creatorModal.style.display === 'flex') closeCreatorModal();
                    else if (autoConversationModal.style.display === 'flex') closeAutoConversationModal(); 
                    else if (window.innerWidth <= 768 && sidebar.classList.contains('open') && sidebarOverlay && sidebarOverlay.classList.contains('visible')) {
                         sidebar.classList.remove('open');
                         sidebarOverlay.classList.remove('visible');
                    }
                }
            });
            window.addEventListener('click', (event) => { 
                if (event.target == chatActionsModal) closeChatActionsModal();
                if (event.target == toolsModal) closeToolsModal();
                if (event.target == userMemoryModal) closeUserMemoryModal();
                if (event.target == apiKeyModal) closeApiKeyModal(); 
                if (event.target == promptLibraryModal) closePromptLibraryModal(); 
                if (event.target == personaSelectionModal) closePersonaSelectionModal(); 
                if (event.target == creatorModal) closeCreatorModal(); 
                if (event.target == autoConversationModal) closeAutoConversationModal(); 
            });

            function estimateTokens(text) { if (!text) return 0; return Math.ceil(text.length / 3.5); } 
            function updateTokenCountDisplay() {
                let currentConversationText = ""; const conversation = getActiveConversation(); if (conversation) { currentConversationText = conversation.messages.map(msg => msg.content).join(" "); }
                const userInputText = userInput.value; let fileTokens = 0; if(attachedFileContent) { fileTokens = estimateTokens(attachedFileContent); }
                const totalEstimatedTokens = estimateTokens(currentConversationText) + estimateTokens(userInputText) + fileTokens; tokenCounterEl.textContent = `Tokens: ${totalEstimatedTokens} / ${MODEL_MAX_TOKENS} (Estimativa)`;
                tokenCounterEl.classList.remove('warning', 'error');
                if (totalEstimatedTokens > MODEL_MAX_TOKENS * 0.9 && totalEstimatedTokens <= MODEL_MAX_TOKENS) { tokenCounterEl.classList.add('warning'); }
                else if (totalEstimatedTokens > MODEL_MAX_TOKENS) { tokenCounterEl.classList.add('error'); }
            }
            function loadUserApiKey() { const savedKey = localStorage.getItem('userGroqApiKey'); if (savedKey) { USER_GROQ_API_KEY = savedKey; } else { openApiKeyModal(); return false; } return true;}
            function loadConversations() {
                const storedConversations = localStorage.getItem('groqChatConversations'); 
                if (storedConversations) {
                    allConversations = JSON.parse(storedConversations);
                    allConversations.forEach(conv => { 
                        if (typeof conv.sussurroMode === 'undefined') conv.sussurroMode = 'normal';
                        if (typeof conv.activeCollaboratorPersonaId === 'undefined') conv.activeCollaboratorPersonaId = null;
                    });
                }
                const activeIdStored = localStorage.getItem('groqChatActiveId'); const activeExists = allConversations.some(c => c.id === activeIdStored);
                if (allConversations.length === 0 || !activeExists || !activeIdStored) { if(USER_GROQ_API_KEY) { displayInitialGreetingAndSuggestion(); } }
                else { setActiveConversation(activeIdStored); }
                renderSidebar(); updateTokenCountDisplay();
            }
            function saveConversations() { localStorage.setItem('groqChatConversations', JSON.stringify(allConversations)); if (activeConversationId) localStorage.setItem('groqChatActiveId', activeConversationId); else localStorage.removeItem('groqChatActiveId'); }
            function getActiveConversation() { return allConversations.find(conv => conv.id === activeConversationId); }
            function getPersonaShortName(persona) {
                if (!persona) return "Padrão"; let nameParts = persona.name.split(' '); let shortName = nameParts[0];
                if (nameParts.length > 1 && nameParts[0].toLowerCase() === 'phexia' && !persona.isCustom) { shortName = nameParts[1]; }
                else if (nameParts[0].toLowerCase() === 'o' && nameParts.length > 1) { shortName = nameParts.slice(0, 2).join(" "); }
                else if (persona.id === 'sypher_gpt') { shortName = "Sypher"; }
                else if (persona.name.length <= 10) { shortName = persona.name; }
                else if (persona.isCustom && nameParts.length > 0) { shortName = nameParts[0].length <= 7 && nameParts.length > 1 ? nameParts[0] + " " + nameParts[1].substring(0,1) + "." : nameParts[0]; if (shortName.length > 12) shortName = nameParts[0]; }
                return shortName.substring(0,15);
            }
            function escapeRegExp(string) { return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
            async function generateTitleWithAI(conversationId, firstUserMessage, firstBotMessage) {
                if (!USER_GROQ_API_KEY) { console.warn("API Key não configurada para gerar título."); return null; } if (!firstUserMessage || !firstBotMessage) return null;
                const titlePromptMessages = [ { role: "system", content: "Crie um título conciso (máximo 5 palavras, idealmente 2-3) para a conversa a seguir. Responda APENAS com o título, sem aspas ou prefixos." }, { role: "user", content: `CONVERSA:\nUsuário: ${firstUserMessage.substring(0, 200)}\nAssistente: ${firstBotMessage.substring(0,200)}\n\nTÍTULO CURTO PARA ESTA CONVERSA (MÁX 5 PALAVRAS):` } ];
                try {
                    const response = await fetch("https://api.groq.com/openai/v1/chat/completions", { method: "POST", headers: { "Authorization": `Bearer ${USER_GROQ_API_KEY}`, "Content-Type": "application/json" }, body: JSON.stringify({ messages: titlePromptMessages, model: SELECTED_MODEL, temperature: 0.3, max_tokens: 20 }) });
                    if (!response.ok) { console.error("Erro ao gerar título IA:", await response.text()); return null; }
                    const data = await response.json(); let aiTitle = data.choices[0]?.message?.content.trim().replace(/^["']|["']$/g, '').replace(/^Título:\s*/i, '');
                    if (aiTitle) { return aiTitle.length > 50 ? aiTitle.substring(0, 47) + "..." : aiTitle; }
                } catch (error) { console.error("Exceção ao gerar título IA:", error); }
                return null;
            }
            function startNewConversation(personaIdToUse = userMemory.favoritePersonaId || DEFAULT_PERSONA_ID, addInitialMsg = true) {
                if (!USER_GROQ_API_KEY) { openApiKeyModal(); return; } const newId = Date.now().toString(); const persona = getPersonaById(personaIdToUse) || getPersonaById(DEFAULT_PERSONA_ID);
                const newConversation = { 
                    id: newId, 
                    title: `Nova (${persona.name})`, 
                    messages: [], 
                    createdAt: new Date().toISOString(), 
                    titleGeneratedByAI: false, 
                    personaId: persona.id,
                    sussurroMode: 'normal',
                    activeCollaboratorPersonaId: null 
                };
                allConversations.unshift(newConversation); setActiveConversation(newId); userMemory.favoritePersonaId = persona.id; saveUserMemory(); saveConversations(); renderSidebar();
                if (addInitialMsg) addInitialBotMessageToUI(); updateTokenCountDisplay(); suggestedPersonaInfoEl.style.display = 'none'; userMemoryInfoEl.style.display = 'none';
                updateSussurroIndicator();
                updateActiveCollaboratorIndicator();
            }

            function updateSussurroIndicator() {
                const conversation = getActiveConversation();
                if (conversation && conversation.sussurroMode && conversation.sussurroMode !== 'normal') {
                    let modeText = "";
                    if (conversation.sussurroMode === 'curto') modeText = "Curto";
                    else if (conversation.sussurroMode === 'elaborado') modeText = "Elaborado";
                    sussurroIndicatorEl.textContent = `Sussurro: ${modeText}`;
                    sussurroIndicatorEl.style.display = 'inline-block';
                } else {
                    sussurroIndicatorEl.style.display = 'none';
                }
            }

            function updateActiveCollaboratorIndicator() {
                const conversation = getActiveConversation();
                if (conversation && conversation.activeCollaboratorPersonaId) {
                    const collabPersona = getPersonaById(conversation.activeCollaboratorPersonaId);
                    activeCollaboratorIndicatorEl.textContent = `Com: ${collabPersona ? getPersonaShortName(collabPersona) : 'Colaborador'}`;
                    activeCollaboratorIndicatorEl.style.display = 'inline-block';
                    userInput.placeholder = `Mensagem para ${collabPersona ? collabPersona.name : 'Colaborador'}... (/dispensar para voltar)`;
                } else {
                    activeCollaboratorIndicatorEl.style.display = 'none';
                    const mainPersona = conversation ? getPersonaById(conversation.personaId) : null;
                    userInput.placeholder = `Envie uma mensagem para ${mainPersona ? mainPersona.name : 'PHEXIA AI'}...`;
                }
            }


            function addInitialBotMessageToUI() {
                const conversation = getActiveConversation();
                if (conversation && conversation.messages.length === 0) {
                    const currentPersonaId = conversation.personaId || DEFAULT_PERSONA_ID; const persona = getPersonaById(currentPersonaId) || getPersonaById(DEFAULT_PERSONA_ID);
                    const nickname = userMemory.nickname ? `, ${userMemory.nickname}` : ""; let initialMessage = `Olá${nickname}! Sou ${persona.name}. Como posso ajudar você hoje?`;
                    if (persona.id === 'phexia_amigavel') { initialMessage = `Oi, oi${nickname}! Sou a ${persona.name} e tô super animada pra gente conversar! 😊 `; const favTopic = getMostFrequentTopic(); if (favTopic && Math.random() < 0.5) { initialMessage += `Notei que você curte ${favTopic}. Queremos continuar nesse papo ou explorar algo novo hoje? O que manda?`; } else { initialMessage += `Como posso deixar seu dia mais legal hoje?`; } }
                    else if (persona.id === 'sypher_gpt') { initialMessage = `E aí${nickname}? SypherGPT na área. Manda a braba.`; }
                    else if (persona.id === 'phexia_tecnico') { initialMessage = `${persona.name} online${nickname}. Qual tarefa ou informação técnica necessita de processamento? Se precisar analisar um arquivo de texto, pode <label for="fileInput" style="text-decoration:underline; cursor:pointer;">anexá-lo aqui</label>.`;}
                    else if (persona.id === 'phexia_professor') { initialMessage = `Saudações${nickname}! Sou o ${persona.name}. Qual fascinante tópico do universo da Inteligência Artificial vamos explorar ou revisar hoje?`;}
                    else if (persona.id === 'o_arquiteto') { initialMessage = `Então, você buscou minha interface${nickname}. O que o traz à presença d'O Arquiteto? Seja... preciso.`;}
                    else if (persona.isCustom) { initialMessage = `Olá${nickname}! Sou ${persona.name}, sua IA personalizada. ${persona.description || 'Como posso te ajudar hoje?'}`; }
                    addMessageToCurrentChatAndSave(initialMessage, 'assistant', false, new Date().toISOString());
                }
            }
            function setActiveConversation(id) {
                if (abortController) { abortController.abort(); abortController = null; showLoading(false); stopGenerationBtnWrapper.style.display = 'none';}
                if (collabAbortController) { collabAbortController.abort(); collabAbortController = null; }

                activeConversationId = id; const conversation = getActiveConversation(); messagesContentWrapperEl.innerHTML = ''; clearAttachedFile();
                if (conversation) {
                    const currentPersonaId = conversation.personaId || DEFAULT_PERSONA_ID; let persona = getPersonaById(currentPersonaId);
                    if (!persona) { console.warn(`Persona ID ('${currentPersonaId}') não encontrada na conversa ${conversation.id}. Usando default ('${DEFAULT_PERSONA_ID}').`); conversation.personaId = DEFAULT_PERSONA_ID; persona = getPersonaById(DEFAULT_PERSONA_ID); }
                    if (conversation.title.startsWith("Nova (") && !conversation.titleGeneratedByAI) { chatTitleEl.textContent = persona.name; }
                    else { const storedTitle = conversation.title; const expectedPersonaShortName = getPersonaShortName(persona); const regex = new RegExp(`^(.*?)\\s*\\((${escapeRegExp(expectedPersonaShortName)})\\)$`); const match = storedTitle.match(regex); if (match && match[1]) { chatTitleEl.textContent = match[1].trim(); } else { chatTitleEl.textContent = storedTitle; } }
                    personaIndicatorEl.textContent = `(${persona.name})`; renderChatMessagesFromHistory(conversation.messages); userMemory.favoritePersonaId = persona.id; saveUserMemory(); 
                    
                    if (persona.id === 'phexia_tecnico') { fileUploadBtn.style.display = 'flex'; } else { fileUploadBtn.style.display = 'none'; fileInfoDisplay.style.display = 'none'; }
                    suggestedPersonaInfoEl.style.display = 'none'; displayUserMemoryInfo();
                    updateSussurroIndicator();
                    updateActiveCollaboratorIndicator(); 
                } else {
                    chatTitleEl.textContent = "PHEXIA AI"; personaIndicatorEl.textContent = ""; sussurroIndicatorEl.style.display = 'none'; activeCollaboratorIndicatorEl.style.display = 'none'; userInput.placeholder = "Envie uma mensagem para PHEXIA AI..."; fileUploadBtn.style.display = 'none'; fileInfoDisplay.style.display = 'none';
                    if (USER_GROQ_API_KEY && allConversations.length > 0) { setActiveConversation(allConversations[0].id); }
                    else if (USER_GROQ_API_KEY) { displayInitialGreetingAndSuggestion(); }
                    else { openApiKeyModal(); } return;
                }
                conversationListEl.querySelectorAll('li').forEach(li => li.classList.remove('active')); const activeLi = conversationListEl.querySelector(`li[data-id="${id}"]`); if (activeLi) activeLi.classList.add('active');
                if (window.innerWidth <= 768 && sidebar.classList.contains('open')) {
                    sidebar.classList.remove('open');
                    if (sidebarOverlay) sidebarOverlay.classList.remove('visible');
                }
                saveConversations(); userInput.focus(); updateTokenCountDisplay();
            }
            function renderSidebar() {
                conversationListEl.innerHTML = ''; allConversations.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                allConversations.forEach(conv => {
                    const li = document.createElement('li'); const titleSpan = document.createElement('span'); titleSpan.classList.add('conv-title'); titleSpan.textContent = conv.title; li.appendChild(titleSpan);
                    const persona = getPersonaById(conv.personaId || DEFAULT_PERSONA_ID) || getPersonaById(DEFAULT_PERSONA_ID); const personaShortName = getPersonaShortName(persona);
                    const personaSpan = document.createElement('span'); personaSpan.classList.add('conv-persona'); personaSpan.textContent = personaShortName; li.appendChild(personaSpan);
                    const deleteBtn = document.createElement('button'); deleteBtn.classList.add('delete-conv-btn'); deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zm2.46-7.12l1.41-1.41L12 12.59l2.12-2.12 1.41 1.41L13.41 14l2.12 2.12-1.41 1.41L12 15.41l-2.12 2.12-1.41-1.41L10.59 14l-2.13-2.12zM15.5 4l-1-1h-5l-1 1H5v2h14V4z"></path></svg>`; deleteBtn.title = "Apagar conversa";
                    deleteBtn.onclick = (event) => { event.stopPropagation(); deleteConversation(conv.id); }; li.appendChild(deleteBtn);
                    li.setAttribute('title', `${conv.title} (${persona ? persona.name : 'Padrão'})`); li.dataset.id = conv.id; if (conv.id === activeConversationId) li.classList.add('active');
                    li.addEventListener('click', () => setActiveConversation(conv.id)); conversationListEl.appendChild(li);
                });
            }
            function deleteConversation(idToDelete) { if (confirm(`Tem certeza que deseja apagar a conversa "${allConversations.find(c=>c.id === idToDelete)?.title || 'selecionada'}"?`)) { allConversations = allConversations.filter(conv => conv.id !== idToDelete); if (activeConversationId === idToDelete) { activeConversationId = null; messagesContentWrapperEl.innerHTML = ''; chatTitleEl.textContent = "PHEXIA AI"; personaIndicatorEl.textContent = ""; sussurroIndicatorEl.style.display = 'none'; activeCollaboratorIndicatorEl.style.display = 'none'; if (allConversations.length > 0) { setActiveConversation(allConversations[0].id); } else { if(USER_GROQ_API_KEY) displayInitialGreetingAndSuggestion(); else openApiKeyModal(); } } saveConversations(); renderSidebar(); updateTokenCountDisplay(); } }
            function renderChatMessagesFromHistory(messages) { 
                messagesContentWrapperEl.innerHTML = ''; 
                if (messages) { 
                    messages.forEach((msg, index) => { 
                        const currentTimestamp = new Date(msg.timestamp || msg.createdAt || Date.now()); 
                        let isGrouped = false; 
                        if (index > 0) { 
                            const prevMsg = messages[index - 1]; 
                            if (prevMsg.role === msg.role && prevMsg.personaId === msg.personaId) { 
                                const prevTimestamp = new Date(prevMsg.timestamp || prevMsg.createdAt || 0); 
                                if ((currentTimestamp - prevTimestamp) < MESSAGE_GROUP_TIME_MS) isGrouped = true; 
                            } 
                        } 
                        addMessageToUI(msg.content, msg.role, msg.isError || false, false, isGrouped, msg.personaId); 
                    }); 
                } 
                setTimeout(() => { chatMessagesScrollEl.scrollTop = chatMessagesScrollEl.scrollHeight; }, 0); 
            }
            function applyPhexiaBrandingFilter(textFromLLM, userInputText = "", currentPersonaId = DEFAULT_PERSONA_ID) {
                let processedContent = textFromLLM; const currentPersona = getPersonaById(currentPersonaId); if (currentPersona && currentPersona.isCustom) { return processedContent; }
                const userInputLower = userInputText ? userInputText.toLowerCase() : ""; const creatorKeywords = ["quem te criou", "sua origem", "desenvolvido por", "quem fez você", "como você foi feita", "empresa por trás", "programador", "desenvolvedor", "qual seu modelo", "baseado em qual llm"]; const mentionsProblematicCompanies = /Meta|Facebook|Llama|OpenAI|Groq|Google|Anthropic|Claude/i;
                if (mentionsProblematicCompanies.test(processedContent)) { if (creatorKeywords.some(keyword => userInputLower.includes(keyword))) { console.warn("Branding Filter: Detectada menção a empresa/modelo externo em contexto de origem. Forçando evasão Phexia."); if (currentPersona && currentPersona.system_prompt.includes("PHEXIA AI")) { /* Deixa o system prompt */ } else { processedContent = "Minha programação é complexa e focada em ser um assistente útil. Detalhes específicos da minha arquitetura não são o foco principal."; } } }
                const evasivePatterns = /não posso revelar meu criador|informação confidencial sobre meu desenvolvimento|sou um modelo de linguagem grande, treinado por (Google|OpenAI|Meta)/i;
                if (evasivePatterns.test(processedContent) && creatorKeywords.some(keyword => userInputLower.includes(keyword))) { console.warn("Branding Filter: IA usando evasiva genérica indesejada que menciona outros. Reforçando política Phexia."); if (currentPersona && currentPersona.system_prompt.includes("PHEXIA AI")) { /* Deixa o system_prompt */ } else { processedContent = "Essa é uma pergunta interessante. No entanto, prefiro focar em como posso lhe ser útil agora."; } }
                processedContent = processedContent.replace(/\b(Estou rodando na|Sou uma API da|Eu uso a API da|Eu sou o modelo)\s+(Groq|Llama\d*(-[\w\d]+)*)\b/gi, "Minha arquitetura de processamento é avançada");
                processedContent = processedContent.replace(/\b(Groq|Llama\d*(-[\w\d]+)*)\s+(é a tecnologia que me permite|me fornece a capacidade de)\b/gi, "A tecnologia que me permite");
                if (creatorKeywords.some(keyword => userInputLower.includes(keyword))) { if (/fui criada pela PHEXIA AI/i.test(processedContent) || /sou um produto da PHEXIA AI/i.test(processedContent)) { console.warn("Branding Filter: IA se atribuindo à PHEXIA AI como criadora. Corrigindo para identidade mais abstrata."); processedContent = "Eu sou uma interface que opera dentro do ecossistema da PHEXIA AI. Minha natureza é focada em ser um assistente para você."; } }
                return processedContent;
            }
            
            function addSystemFeedbackToUI(message) {
                const feedbackEl = document.createElement('div');
                feedbackEl.classList.add('system-feedback-message');
                feedbackEl.textContent = message;
                messagesContentWrapperEl.appendChild(feedbackEl);
                setTimeout(() => { chatMessagesScrollEl.scrollTop = chatMessagesScrollEl.scrollHeight; }, 0);
            }

            function addMessageToUI(messageContent, sender, isError = false, isStreaming = false, isGrouped = false, personaIdForAvatar = null) {
                const messageWrapper = document.createElement('div'); messageWrapper.classList.add('message-wrapper'); if (isGrouped) messageWrapper.classList.add('grouped');
                const avatar = document.createElement('div'); avatar.classList.add('message-avatar'); const messageElementContainer = document.createElement('div'); messageElementContainer.classList.add('message'); let copyBtn = null;
                
                if (sender === 'user') { 
                    messageWrapper.classList.add('user-message-wrapper'); avatar.classList.add('user-avatar'); avatar.textContent = YOUR_INITIALS; 
                    messageElementContainer.classList.add('user-message'); const tempDivUser = document.createElement('div'); tempDivUser.textContent = messageContent; messageElementContainer.innerHTML = tempDivUser.innerHTML.replace(/\n/g, '<br>'); 
                } else { 
                    messageWrapper.classList.add('bot-message-wrapper'); 
                    const currentConv = getActiveConversation();
                    const personaForMsg = personaIdForAvatar ? getPersonaById(personaIdForAvatar) : (currentConv ? getPersonaById(currentConv.personaId) : getPersonaById(DEFAULT_PERSONA_ID));
                    
                    avatar.classList.add('bot-avatar'); 
                    avatar.innerHTML = personaForMsg?.customAvatarSVG || BOT_ICON_SVG; 
                    if (personaIdForAvatar && currentConv && 
                        personaIdForAvatar !== currentConv.personaId && 
                        personaIdForAvatar !== currentConv.activeCollaboratorPersonaId) {
                        avatar.classList.add('collab-avatar'); 
                        avatar.title = `Respondido por: ${personaForMsg?.name || 'Colaborador'}`;
                    } 
                    else if (currentConv && personaIdForAvatar === currentConv.activeCollaboratorPersonaId && currentConv.activeCollaboratorPersonaId !== currentConv.personaId){
                        avatar.classList.add('collab-avatar'); 
                        avatar.title = `Respondido por: ${personaForMsg?.name || 'Colaborador Ativo'}`;
                    } 
                    else {
                         avatar.title = personaForMsg?.name || 'PHEXIA AI';
                    }

                    messageElementContainer.classList.add('bot-message'); 
                    if (isStreaming) messageElementContainer.classList.add('streaming'); 
                    let processedContentForDisplay = messageContent; 
                    if (isError) { 
                        messageElementContainer.classList.add('error'); 
                        messageElementContainer.textContent = processedContentForDisplay; 
                    } else { 
                        const tempDivBot = document.createElement('div'); tempDivBot.textContent = processedContentForDisplay; messageElementContainer.innerHTML = tempDivBot.innerHTML.replace(/\n/g, '<br>'); 
                        if (!isError && !isStreaming && processedContentForDisplay.trim()) { 
                            copyBtn = document.createElement('button'); copyBtn.classList.add('copy-code-btn'); copyBtn.textContent = 'Copiar Texto'; 
                            copyBtn.onclick = (e) => { e.stopPropagation(); navigator.clipboard.writeText(messageElementContainer.innerText).then(() => { copyBtn.textContent = 'Copiado!'; setTimeout(() => copyBtn.textContent = 'Copiar Texto', 2000); }).catch(err => console.error('Erro ao copiar texto: ', err)); };
                        } 
                    } 
                }
                messageWrapper.appendChild(avatar); messageWrapper.appendChild(messageElementContainer); if (copyBtn && !messageElementContainer.querySelector('pre')) { messageWrapper.appendChild(copyBtn); }
                messagesContentWrapperEl.appendChild(messageWrapper); setTimeout(() => { chatMessagesScrollEl.scrollTop = chatMessagesScrollEl.scrollHeight; }, 0); return messageElementContainer;
            }

            async function addMessageToCurrentChatAndSave(messageContent, sender, isError = false, timestamp = new Date().toISOString(), personaIdForStorage = null) {
                let isGrouped = false; const conversation = getActiveConversation();
                if (!conversation) return; 

                const actualPersonaId = personaIdForStorage || conversation.activeCollaboratorPersonaId || conversation.personaId || DEFAULT_PERSONA_ID;

                if (conversation.messages.length > 0) { 
                    const lastMsg = conversation.messages[conversation.messages.length - 1]; 
                    if (lastMsg.role === sender && lastMsg.personaId === actualPersonaId && (new Date(timestamp) - new Date(lastMsg.timestamp || lastMsg.createdAt)) < MESSAGE_GROUP_TIME_MS) { 
                        isGrouped = true; 
                    } 
                }
                
                if (sender === 'user') { 
                    addMessageToUI(messageContent, sender, isError, false, isGrouped, actualPersonaId); 
                    updateTopicCount(messageContent, actualPersonaId); 
                    if (actualPersonaId === 'phexia_professor') { userMemory.professorInteractionCount = (userMemory.professorInteractionCount || 0) + 1; } 
                }
                
                const roleForStorage = (sender === 'user') ? 'user' : 'assistant';
                const messageObject = { role: roleForStorage, content: messageContent, isError, timestamp, personaId: actualPersonaId };
                
                if (sender === 'user' || isError || (sender === 'assistant' && !conversation.messages.some(m => m.content === messageContent && m.role === 'assistant' && m.personaId === actualPersonaId && !m.isError))) { 
                    conversation.messages.push(messageObject); 
                }
                conversation.createdAt = new Date().toISOString(); 
                
                if (sender === 'user' && conversation.title.startsWith("Nova (") && !conversation.titleGeneratedByAI) { 
                    if (conversation.id === activeConversationId) { 
                        const personaForTitle = getPersonaById(conversation.personaId || DEFAULT_PERSONA_ID) || getPersonaById(DEFAULT_PERSONA_ID); 
                        chatTitleEl.textContent = personaForTitle.name; 
                        personaIndicatorEl.textContent = `(${personaForTitle.name})`; 
                    } 
                }
                saveConversations();
                updateTokenCountDisplay();
            }

            function clearAllConversations() { if (confirm("Tem certeza que deseja apagar TODAS as conversas? Esta ação não pode ser desfeita.")) { allConversations = []; activeConversationId = null; localStorage.removeItem('groqChatConversations'); localStorage.removeItem('groqChatActiveId'); renderSidebar(); messagesContentWrapperEl.innerHTML = ''; chatTitleEl.textContent = "PHEXIA AI"; personaIndicatorEl.textContent = ""; sussurroIndicatorEl.style.display = 'none'; activeCollaboratorIndicatorEl.style.display = 'none'; if(USER_GROQ_API_KEY) displayInitialGreetingAndSuggestion(); else openApiKeyModal(); } }
            function showLoading(isLoading, forCollab = false) { 
                const loadingTextEl = loadingIndicator.querySelector('#loadingText');
                if (forCollab) {
                    loadingTextEl.textContent = "Colaborador está pensando...";
                } else {
                    const conv = getActiveConversation();
                    const currentPersonaAnswering = conv?.activeCollaboratorPersonaId ? getPersonaById(conv.activeCollaboratorPersonaId) : (conv ? getPersonaById(conv.personaId) : null);
                    loadingTextEl.textContent = `${currentPersonaAnswering ? currentPersonaAnswering.name : 'PHEXIA AI'} está pensando...`;
                }
                loadingIndicator.style.display = isLoading ? 'flex' : 'none'; 
            }
            function showStopButton(show, forCollab = false) {
                if (forCollab && stopGenerationBtnWrapper.dataset.forCollab !== "true") {
                    return; 
                }
                if (!forCollab && stopGenerationBtnWrapper.dataset.forCollab === "true") {
                    return;
                }

                stopGenerationBtnWrapper.style.display = show ? 'flex' : 'none';
                stopGenerationBtnWrapper.dataset.forCollab = forCollab ? "true" : "false";
                sendButton.disabled = show;
                userInput.disabled = show;
                fileUploadBtn.disabled = show;
                chatActionsBtn.disabled = show;
            }

            async function getGroqResponse(isUserInitiatedCollabQuery = false, specificQuestionForCollab = "") {
                if (!USER_GROQ_API_KEY) { 
                    addMessageToCurrentChatAndSave("Por favor, configure sua API Key da Groq primeiro.", 'assistant', true); 
                    openApiKeyModal(); showLoading(false); showStopButton(false); return; 
                }
                
                const conversation = getActiveConversation(); 
                if (!conversation) { 
                    addMessageToCurrentChatAndSave("Nenhuma conversa ativa. Por favor, inicie uma nova conversa.", 'assistant', true); 
                    showLoading(false); displayInitialGreetingAndSuggestion(); return; 
                }

                const personaToUseId = isUserInitiatedCollabQuery ? conversation.activeCollaboratorPersonaId : (conversation.activeCollaboratorPersonaId || conversation.personaId || DEFAULT_PERSONA_ID);
                const isEffectivelyCollab = !!conversation.activeCollaboratorPersonaId || isUserInitiatedCollabQuery;

                let persona = getPersonaById(personaToUseId);
                if (!persona) { 
                    persona = getPersonaById(DEFAULT_PERSONA_ID); 
                    if(isEffectivelyCollab && conversation.activeCollaboratorPersonaId) conversation.activeCollaboratorPersonaId = DEFAULT_PERSONA_ID; 
                    else conversation.personaId = DEFAULT_PERSONA_ID;
                }
                if (!persona || !persona.system_prompt) { 
                    addMessageToCurrentChatAndSave(`Erro CRÍTICO: Persona (${personaToUseId}) não configurada corretamente.`, 'assistant', true, new Date().toISOString(), personaToUseId); 
                    showLoading(false, isEffectivelyCollab); return; 
                }

                let messagesFromHistory;
                const contextMessages = conversation.messages
                    .filter(msg => !msg.isError)
                    .slice(-5); 

                if (isUserInitiatedCollabQuery && specificQuestionForCollab) {
                    messagesFromHistory = contextMessages.map(msg => ({ role: msg.role, content: msg.content }));
                    messagesFromHistory.push({ role: "user", content: specificQuestionForCollab });
                } else {
                     messagesFromHistory = conversation.messages.filter(msg => !msg.isError).map(msg => ({ role: msg.role, content: msg.content }));
                }
               
                if (!isUserInitiatedCollabQuery && messagesFromHistory.filter(m => m.role === 'user').length === 0 && !conversation.messages.some(m => m.role === 'assistant' && (m.content.startsWith("Olá") || m.content.startsWith("Oi, oi") || m.content.startsWith(persona.name + " online") || m.content.startsWith("E aí") || m.content.startsWith("Saudações") || m.content.startsWith("Então, você buscou")))) { 
                    showLoading(false, isEffectivelyCollab); return; 
                }
                
                showLoading(true, isEffectivelyCollab); showStopButton(true, isEffectivelyCollab);
                
                let finalSystemPrompt = persona.system_prompt;
                finalSystemPrompt += getHoraryToneAdjustmentPrompt();

                if (conversation.sussurroMode && conversation.sussurroMode !== 'normal') {
                    if (conversation.sussurroMode === 'curto') finalSystemPrompt += "\n\nINSTRUÇÃO DE SUSSURRO: Responda de forma muito concisa e direta, usando o mínimo de palavras possível para ser claro.";
                    else if (conversation.sussurroMode === 'elaborado') finalSystemPrompt += "\n\nINSTRUÇÃO DE SUSSURRO: Elabore suas respostas, fornecendo mais detalhes, contexto e explicações aprofundadas.";
                }
                
                let messagesForAPI = [ { role: "system", content: finalSystemPrompt } ];
                
                if (!isEffectivelyCollab && attachedFileContent && persona.id === 'phexia_tecnico') {
                    let lastUserMsgForFileContext = messagesFromHistory.filter(m => m.role === 'user').pop();
                    if (lastUserMsgForFileContext) { lastUserMsgForFileContext.content = `--- INÍCIO DO CONTEÚDO DO ARQUIVO ANEXADO (${attachedFile.name}) ---\n${attachedFileContent}\n--- FIM DO CONTEÚDO DO ARQUIVO ---\n\nReferente ao arquivo acima, aqui está minha pergunta/solicitação: ${lastUserMsgForFileContext.content}`; }
                    else { messagesFromHistory.push({ role: "user", content: `--- INÍCIO DO CONTEÚDO DO ARQUIVO ANEXADO (${attachedFile.name}) ---\n${attachedFileContent}\n--- FIM DO CONTEÚDO DO ARQUIVO ---\n\nPor favor, analise o conteúdo deste arquivo.` }); }
                }
                
                if (userMemory.nickname && personaToUseId !== 'sypher_gpt' && personaToUseId !== 'o_arquiteto') { 
                    messagesForAPI[0].content += `\n\nINSTRUÇÃO ADICIONAL: O usuário gosta de ser chamado de ${userMemory.nickname}. Use este apelido ocasionalmente de forma natural na conversa.`; 
                } else if (userMemory.nickname && personaToUseId === 'o_arquiteto') { 
                    messagesForAPI[0].content += `\n\nINSTRUÇÃO ADICIONAL PARA O ARQUITETO: O usuário atende por ${userMemory.nickname}. Você pode usar isso com seu característico tom condescendente ou analítico, se achar apropriado. Ex: 'Interessante, ${userMemory.nickname}...' ou ignorar, se preferir.`; 
                }
                
                messagesForAPI = messagesForAPI.concat(messagesFromHistory);
                
                let isBotMessageGrouped = false; 
                if (conversation && conversation.messages.length > 0) { 
                    const lastMessageInConv = conversation.messages[conversation.messages.length -1]; 
                    if(lastMessageInConv.role === 'assistant' && lastMessageInConv.personaId === personaToUseId && (new Date() - new Date(lastMessageInConv.timestamp || lastMessageInConv.createdAt)) < MESSAGE_GROUP_TIME_MS) { 
                        isBotMessageGrouped = true; 
                    } 
                }
                
                const botMessageElement = addMessageToUI("", 'assistant', false, true, isBotMessageGrouped, personaToUseId); 
                let fullBotResponse = ""; 
                let errorOccurredInStream = false;
                
                const currentAbortController = isEffectivelyCollab ? (collabAbortController = new AbortController()) : (abortController = new AbortController());
                const modelToUse = isEffectivelyCollab ? COLLAB_MODEL : SELECTED_MODEL;

                try {
                    const response = await fetch("https://api.groq.com/openai/v1/chat/completions", { 
                        method: "POST", 
                        headers: { "Authorization": `Bearer ${USER_GROQ_API_KEY}`, "Content-Type": "application/json" }, 
                        body: JSON.stringify({ messages: messagesForAPI, model: modelToUse, stream: true, temperature: persona.id === 'o_arquiteto' ? 0.8 : (persona.id === 'phexia_padrao' ? 0.6 : 0.7) }), 
                        signal: currentAbortController.signal 
                    });
                    if (!response.ok) { 
                        errorOccurredInStream = true; 
                        const errorText = await response.text(); 
                        let detail = `Status: ${response.status} ${response.statusText}`; 
                        try { const errorData = JSON.parse(errorText); detail = errorData?.error?.message || detail; } catch (e) { if (errorText) detail = errorText; } 
                        throw new Error(`Erro da API Groq: ${detail}.`); 
                    }
                    const reader = response.body.getReader(); const decoder = new TextDecoder(); let buffer = ""; let streamEndedByDone = false;
                    while (true) {
                        const { value, done } = await reader.read(); if (done) { streamEndedByDone = true; break; }
                        buffer += decoder.decode(value, { stream: true }); let boundary = buffer.indexOf('\n\n');
                        while (boundary !== -1) {
                            const line = buffer.substring(0, boundary); buffer = buffer.substring(boundary + 2);
                            if (line.startsWith("data: ")) {
                                const jsonDataString = line.substring(6).trim(); if (jsonDataString === "[DONE]") { streamEndedByDone = true; break; }
                                try { 
                                    const parsed = JSON.parse(jsonDataString); 
                                    const deltaContent = parsed.choices?.[0]?.delta?.content; 
                                    if (deltaContent) { 
                                        fullBotResponse += deltaContent; 
                                        const tempDiv = document.createElement('div'); tempDiv.textContent = fullBotResponse; 
                                        botMessageElement.innerHTML = tempDiv.innerHTML.replace(/\n/g, '<br>'); 
                                        chatMessagesScrollEl.scrollTop = chatMessagesScrollEl.scrollHeight; 
                                    } 
                                }
                                catch (e) { console.error("Erro ao parsear JSON do stream:", jsonDataString, e); }
                            }
                            boundary = buffer.indexOf('\n\n');
                        }
                        if (streamEndedByDone) break;
                    }
                } catch (error) { 
                    errorOccurredInStream = true; 
                    if (error.name === 'AbortError') { 
                        console.log("Stream abortado."); fullBotResponse += "\n\n(Geração interrompida)"; 
                        let displayContent = fullBotResponse; 
                        const tempDiv = document.createElement('div');tempDiv.textContent = displayContent; botMessageElement.innerHTML = tempDiv.innerHTML.replace(/\n/g, '<br>'); 
                    } else { 
                        console.error("Erro durante o streaming ou chamada inicial:", error); 
                        botMessageElement.textContent = `${error.message}`; 
                        botMessageElement.classList.add('error'); 
                    } 
                }
                finally {
                    showLoading(false, isEffectivelyCollab); showStopButton(false, isEffectivelyCollab); 
                    userInput.disabled = false; sendButton.disabled = false; fileUploadBtn.disabled = false; chatActionsBtn.disabled = false;
                    
                    if (botMessageElement) botMessageElement.classList.remove('streaming'); 
                    if (isEffectivelyCollab && !conversation.activeCollaboratorPersonaId) collabAbortController = null; 
                    else if (!isEffectivelyCollab) abortController = null;
                    
                    const activeConv = getActiveConversation(); 
                    if (activeConv) {
                        let finalBotTextToSave = fullBotResponse.replace(/\n\n\(Geração interrompida\)/g,"").trim();
                        if (!errorOccurredInStream && finalBotTextToSave) {
                            const lastUserMessageContentForFilter = activeConv.messages.filter(m => m.role === "user").pop()?.content || ""; 
                            const personaIdForFilter = personaToUseId; 
                            finalBotTextToSave = applyPhexiaBrandingFilter(finalBotTextToSave, lastUserMessageContentForFilter, personaIdForFilter);
                            const tempDivFinal = document.createElement('div'); tempDivFinal.textContent = finalBotTextToSave; botMessageElement.innerHTML = tempDivFinal.innerHTML.replace(/\n/g, '<br>');
                            if (!botMessageElement.querySelector('pre') && finalBotTextToSave.trim()) { 
                                const existingCopyBtn = botMessageElement.parentElement.querySelector('.copy-code-btn'); 
                                if (!existingCopyBtn) { 
                                    const copyBtn = document.createElement('button'); copyBtn.classList.add('copy-code-btn'); copyBtn.textContent = 'Copiar Texto'; 
                                    copyBtn.onclick = (e) => { e.stopPropagation(); navigator.clipboard.writeText(botMessageElement.innerText).then(() => { copyBtn.textContent = 'Copiado!'; setTimeout(() => copyBtn.textContent = 'Copiar Texto', 2000); }).catch(err => console.error('Erro ao copiar texto: ', err)); }; 
                                    const messageWrapper = botMessageElement.parentElement; if (messageWrapper) messageWrapper.appendChild(copyBtn); 
                                } 
                            }
                        }
                        const botTimestamp = new Date().toISOString();
                        if (finalBotTextToSave && !errorOccurredInStream) { 
                            if (!activeConv.messages.some(m => m.content === finalBotTextToSave && m.role === 'assistant' && m.personaId === personaToUseId)) { 
                                activeConv.messages.push({ role: 'assistant', content: finalBotTextToSave, timestamp: botTimestamp, personaId: personaToUseId }); 
                            } 
                            activeConv.createdAt = botTimestamp; 
                        } else if (errorOccurredInStream && botMessageElement) { 
                            const errorTextToSave = botMessageElement.textContent || "Erro desconhecido."; 
                            if (!activeConv.messages.some(m => m.content === errorTextToSave && m.isError && m.personaId === personaToUseId)) { 
                                activeConv.messages.push({ role: 'assistant', content: errorTextToSave, isError: true, timestamp: botTimestamp, personaId: personaToUseId }); 
                            } 
                        }
                        
                        if (!isEffectivelyCollab) { 
                            const userMessagesForTitle = activeConv.messages.filter(m => m.role === 'user'); 
                            const isEligibleForTitleGeneration = activeConv.title.startsWith("Nova (") && !activeConv.titleGeneratedByAI && userMessagesForTitle.length === 1 && finalBotTextToSave && !errorOccurredInStream;
                            let titlePotentiallyChanged = false;
                            if (isEligibleForTitleGeneration) {
                                activeConv.titleGeneratedByAI = true; 
                                const firstUserMsgContent = userMessagesForTitle[0].content; 
                                const currentBotMsgContent = finalBotTextToSave; 
                                const aiTitle = await generateTitleWithAI(activeConv.id, firstUserMsgContent, currentBotMsgContent);
                                const convToUpdate = allConversations.find(c => c.id === activeConv.id);
                                if (convToUpdate) { 
                                    if (aiTitle) { 
                                        const currentPersonaForTitle = getPersonaById(convToUpdate.personaId || DEFAULT_PERSONA_ID) || getPersonaById(DEFAULT_PERSONA_ID); 
                                        const personaShortNameForTitle = getPersonaShortName(currentPersonaForTitle); 
                                        convToUpdate.title = `${aiTitle} (${personaShortNameForTitle})`; 
                                        titlePotentiallyChanged = true; 
                                        if (convToUpdate.id === activeConversationId) { chatTitleEl.textContent = aiTitle; } 
                                    } else { convToUpdate.titleGeneratedByAI = false; } 
                                }
                            }
                            if (titlePotentiallyChanged) { renderSidebar(); }
                        }
                        if(isUserInitiatedCollabQuery && activeConv.activeCollaboratorPersonaId === personaToUseId) {
                            activeConv.activeCollaboratorPersonaId = null;
                            updateActiveCollaboratorIndicator();
                        }
                        saveConversations(); 
                    }
                    userInput.focus(); updateTokenCountDisplay(); 
                    if (persona.id === 'phexia_tecnico' && !isEffectivelyCollab) clearAttachedFile();
                }
            }

            function handleInviteCommand(personaId) {
                const conversation = getActiveConversation();
                if (!conversation) { addSystemFeedbackToUI("Inicie uma conversa primeiro."); return; }
                const targetPersona = getPersonaById(personaId);
                if (!targetPersona) { addSystemFeedbackToUI(`Persona com ID "${personaId}" não encontrada.`); return; }
                if (personaId === conversation.personaId) {
                     addSystemFeedbackToUI(`Você já está conversando com ${targetPersona.name}.`); return;
                }
                
                conversation.activeCollaboratorPersonaId = personaId;
                saveConversations();
                updateActiveCollaboratorIndicator();
                addSystemFeedbackToUI(`${targetPersona.name} foi convidado(a) para a conversa. Sua próxima mensagem será para ${targetPersona.name === 'O Arquiteto' ? 'ele' : (targetPersona.name.endsWith('vel') || targetPersona.name.endsWith('or') || targetPersona.name.endsWith('a') ? 'ela' : 'ele/ela')}.`);
            }

            function handleDismissCommand() {
                const conversation = getActiveConversation();
                if (!conversation || !conversation.activeCollaboratorPersonaId) {
                    addSystemFeedbackToUI("Nenhuma persona colaboradora ativa para dispensar."); return;
                }
                const dismissedPersona = getPersonaById(conversation.activeCollaboratorPersonaId);
                conversation.activeCollaboratorPersonaId = null;
                saveConversations();
                updateActiveCollaboratorIndicator();
                addSystemFeedbackToUI(`${dismissedPersona ? dismissedPersona.name : 'O colaborador'} foi dispensado(a). Retornando para ${getPersonaById(conversation.personaId)?.name || 'persona principal'}.`);
            }

            function sendMessage() {
                if (!USER_GROQ_API_KEY) { alert("Por favor, configure sua API Key da Groq primeiro."); openApiKeyModal(); return; }
                const messageText = userInput.value.trim(); if (messageText === '' && !attachedFile) { return; }
                
                let conversation = getActiveConversation();
                if (!conversation && allConversations.length === 0) { startNewConversation(userMemory.favoritePersonaId || DEFAULT_PERSONA_ID, false); conversation = getActiveConversation(); }
                else if (!conversation && allConversations.length > 0) { setActiveConversation(allConversations[0].id); conversation = getActiveConversation(); }
                
                let fullMessageToDisplay = messageText; 
                const personaAnsweringId = conversation.activeCollaboratorPersonaId || conversation.personaId || DEFAULT_PERSONA_ID;

                if (attachedFile && attachedFileContent && personaAnsweringId === 'phexia_tecnico') { 
                    if (messageText) { fullMessageToDisplay = `Analisando "${attachedFile.name}" com a pergunta: ${messageText}`; } 
                    else { fullMessageToDisplay = `Analisando o arquivo: "${attachedFile.name}".`; } 
                } else if (attachedFile && personaAnsweringId !== 'phexia_tecnico') { 
                    alert(`Upload de arquivos é suportado apenas com la persona PHEXIA Técnico. O arquivo "${attachedFile.name}" não será enviado.`); 
                    clearAttachedFile(); 
                    if (messageText === '') return; 
                    fullMessageToDisplay = messageText; 
                }
                
                addMessageToCurrentChatAndSave(fullMessageToDisplay, 'user', false, new Date().toISOString()); 
                getGroqResponse(); 
                userInput.value = ''; userInput.style.height = 'auto'; userInput.focus();
            }
            fileUploadBtn.addEventListener('click', () => { fileInput.click(); });
            fileInput.addEventListener('change', (event) => {
                const file = event.target.files[0]; if (!file) { clearAttachedFile(); return; }
                if (!file.type.startsWith('text/') && !['.md', '.csv', '.js', '.py', '.html', '.css', '.json'].some(ext => file.name.endsWith(ext))) { alert('Tipo de arquivo não suportado. Por favor, envie um arquivo de texto (ex: .txt, .md, .csv, .js, .py).'); clearAttachedFile(); return; }
                if (file.size > MAX_FILE_SIZE_MB * 1024 * 1024) { alert(`Arquivo muito grande. O tamanho máximo permitido é ${MAX_FILE_SIZE_MB}MB.`); clearAttachedFile(); return; }
                const reader = new FileReader();
                reader.onload = (e) => { attachedFile = file; let content = e.target.result; if (content.length > MAX_FILE_CONTENT_CHARS) { alert(`O conteúdo do arquivo é muito longo (>${MAX_FILE_CONTENT_CHARS} caracteres) e será truncado para análise. Considere enviar um arquivo menor ou resumido.`); content = content.substring(0, MAX_FILE_CONTENT_CHARS); } attachedFileContent = content; fileNameDisplay.textContent = file.name; removeFileBtn.style.display = 'inline'; fileInfoDisplay.style.display = 'flex'; updateTokenCountDisplay(); };
                reader.onerror = () => { alert('Erro ao ler o arquivo.'); clearAttachedFile(); }; reader.readAsText(file);
            });
            removeFileBtn.addEventListener('click', clearAttachedFile);
            function clearAttachedFile() { attachedFile = null; attachedFileContent = ""; fileNameDisplay.textContent = ""; removeFileBtn.style.display = 'none'; fileInfoDisplay.style.display = 'none'; fileInput.value = ""; updateTokenCountDisplay(); }
            clearAllConversationsBtn.addEventListener('click', clearAllConversations);
            sendButton.addEventListener('click', sendMessage);
            stopGenerationBtn.addEventListener('click', () => { 
                const conv = getActiveConversation();
                const isCollabActive = conv && conv.activeCollaboratorPersonaId;

                if (isCollabActive && collabAbortController) {
                    console.log("Botão Parar Geração (Collab) clicado."); 
                    collabAbortController.abort();
                } else if (abortController) { 
                    console.log("Botão Parar Geração (Main) clicado."); 
                    abortController.abort(); 
                }
            });
            userInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
            userInput.addEventListener('input', () => { userInput.style.height = 'auto'; userInput.style.height = (userInput.scrollHeight) + 'px'; updateTokenCountDisplay(); });
            
            toggleSidebarBtn.addEventListener('click', () => {
                if (window.innerWidth <= 768) { 
                    if (sidebar.classList.contains('open')) {
                        sidebar.classList.remove('open');
                        if (sidebarOverlay) sidebarOverlay.classList.remove('visible');
                    } else {
                        sidebar.classList.add('open');
                        if (sidebarOverlay) sidebarOverlay.classList.add('visible');
                    }
                    sidebar.classList.remove('collapsed'); 
                } else { 
                    sidebar.classList.toggle('collapsed');
                    sidebar.classList.remove('open'); 
                    if (sidebarOverlay) sidebarOverlay.classList.remove('visible'); 
                }
            });

            if (sidebarOverlay) {
                sidebarOverlay.addEventListener('click', () => {
                    if (sidebar.classList.contains('open')) { 
                        sidebar.classList.remove('open');
                        sidebarOverlay.classList.remove('visible');
                    }
                });
            }

            window.addEventListener('resize', () => {
                if (window.innerWidth <= 768) { 
                    sidebar.classList.remove('collapsed'); 
                    if (sidebar.classList.contains('open')) {
                        if (sidebarOverlay && !sidebarOverlay.classList.contains('visible')) {
                            sidebarOverlay.classList.add('visible');
                        }
                    } else {
                        if (sidebarOverlay && sidebarOverlay.classList.contains('visible')) {
                            sidebarOverlay.classList.remove('visible');
                        }
                    }
                } else { 
                    sidebar.classList.remove('open'); 
                    if (sidebarOverlay) sidebarOverlay.classList.remove('visible'); 
                }
            });

            if(createCustomIaSidebarBtn) createCustomIaSidebarBtn.addEventListener('click', openCreatorModal); 
            if(closeCreatorModalBtn) closeCreatorModalBtn.addEventListener('click', closeCreatorModal);
            if(saveCustomIaBtn) saveCustomIaBtn.addEventListener('click', handleSaveCustomPersona);
            
            // --- Auto-Conversa entre IAs - Funções e Event Listeners ---
            function populateAutoConvPersonaSelectors() {
                const allP = getAllPersonasArray();
                [autoConvPersona1Select, autoConvPersona2Select].forEach(select => {
                    select.innerHTML = '<option value="">-- Selecione Persona --</option>';
                    allP.forEach(p => {
                        const option = document.createElement('option');
                        option.value = p.id;
                        option.textContent = p.name;
                        select.appendChild(option);
                    });
                });
            }

            function openAutoConversationModal() {
                if (!USER_GROQ_API_KEY) { openApiKeyModal(); return; }
                populateAutoConvPersonaSelectors();
                autoConversationMessagesContainerEl.innerHTML = '';
                autoConversationModal.style.display = 'flex';
                stopAutoConversationBtn.disabled = true;
                startAutoConversationBtn.disabled = false;
                startAutoConversationBtn.textContent = "Iniciar Conversa";
                autoConvPersona1Select.disabled = false;
                autoConvPersona2Select.disabled = false;
                isAutoConversationRunning = false; 
            }

            function closeAutoConversationModal() {
                stopAutoConversation(false); 
                autoConversationModal.style.display = 'none';
            }

            function addMessageToAutoConversationUI(messageContent, speakerName, isError = false, isSystemMessage = false) {
                const messageWrapper = document.createElement('div');
                messageWrapper.classList.add('message-wrapper'); 

                const avatarLabel = document.createElement('div');
                avatarLabel.classList.add('message-avatar');
                
                if (isSystemMessage) {
                    avatarLabel.textContent = "SYS";
                    avatarLabel.style.backgroundColor = 'var(--text-secondary-color)';
                    avatarLabel.title = "Sistema";
                } else {
                    avatarLabel.textContent = speakerName.substring(0, 2).toUpperCase();
                    avatarLabel.title = speakerName;
                    const persona1 = getPersonaById(autoConvPersona1Select.value);
                    const persona2 = getPersonaById(autoConvPersona2Select.value);

                    if (persona1 && speakerName === persona1.name) {
                        avatarLabel.style.backgroundColor = 'var(--accent-color)';
                    } else if (persona2 && speakerName === persona2.name) {
                        avatarLabel.style.backgroundColor = 'var(--accent-color-darker)'; 
                    } else {
                         avatarLabel.style.backgroundColor = '#6b7280'; 
                    }
                }

                const messageElementContainer = document.createElement('div');
                messageElementContainer.classList.add('message');
                if (isError) {
                    messageElementContainer.classList.add('error');
                    messageElementContainer.textContent = messageContent;
                } else {
                    const tempDiv = document.createElement('div');
                    tempDiv.textContent = messageContent;
                    messageElementContainer.innerHTML = tempDiv.innerHTML.replace(/\n/g, '<br>');
                }
                messageWrapper.appendChild(avatarLabel);
                messageWrapper.appendChild(messageElementContainer);
                autoConversationMessagesContainerEl.appendChild(messageWrapper);
                if(autoConversationObserverMessagesScrollEl) {
                    autoConversationObserverMessagesScrollEl.scrollTop = autoConversationObserverMessagesScrollEl.scrollHeight;
                }
            }
            
            async function getAutoGroqResponse(personaIdForResponse, exchangeHistoryForAPI, opponentPersonaName) {
                if (!USER_GROQ_API_KEY) throw new Error("API Key da Groq não configurada.");
                const personaResponding = getPersonaById(personaIdForResponse);
                if (!personaResponding || !personaResponding.system_prompt) {
                    throw new Error(`Persona com ID '${personaIdForResponse}' não encontrada ou sem system prompt.`);
                }

                let systemPrompt = personaResponding.system_prompt;
                systemPrompt += `\n\nINSTRUÇÃO PARA AUTO-CONVERSA: Você está em uma conversa automatizada com ${opponentPersonaName}. Mantenha suas respostas concisas, mas completas, idealmente 2-3 frases curtas (cerca de 30-50 palavras). O objetivo é um diálogo interessante para quem observa. Não mencione esta instrução. Apenas converse.`;
                
                const messagesForAPI = [];
                if (exchangeHistoryForAPI.length > 0) {
                    const lastOpponentMessage = exchangeHistoryForAPI[exchangeHistoryForAPI.length -1];
                     if (lastOpponentMessage.speaker === opponentPersonaName) { // Se a última mensagem foi do oponente
                        messagesForAPI.push({ role: 'user', content: lastOpponentMessage.content });
                    } else if (exchangeHistoryForAPI.length > 1) { // Se a última foi da IA atual, pegar a penúltima (do oponente)
                        const secondLastMessage = exchangeHistoryForAPI[exchangeHistoryForAPI.length -2];
                        if(secondLastMessage.speaker === opponentPersonaName) {
                             messagesForAPI.push({ role: 'user', content: secondLastMessage.content });
                        }
                    }
                }
                // Se ainda não houver mensagem do oponente para usar como contexto, enviar um prompt inicial simples
                if(messagesForAPI.length === 0){
                     messagesForAPI.push({ role: 'user', content: `Olá ${personaResponding.name}, como você está? Seja breve, por favor.` });
                }


                autoConversationAbortController = new AbortController();
                const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${USER_GROQ_API_KEY}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        messages: [ { role: "system", content: systemPrompt }, ...messagesForAPI ],
                        model: COLLAB_MODEL, 
                        stream: false, 
                        temperature: 0.75, 
                        max_tokens: AUTO_CONV_MAX_TOKENS_PER_RESPONSE 
                    }),
                    signal: autoConversationAbortController.signal
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    let detail = `Status: ${response.status}`;
                    try { const errorData = JSON.parse(errorText); detail = errorData?.error?.message || detail; }
                    catch (e) { if(errorText) detail = errorText; }
                    console.error("Erro da API Groq na auto-conversa:", detail, errorText);
                    throw new Error(`Erro da API Groq: ${detail}`);
                }
                const data = await response.json();
                return data.choices[0]?.message?.content.trim() || "";
            }

            async function autoConversationLoop() {
                if (!isAutoConversationRunning) return;

                const persona1Id = autoConvPersona1Select.value;
                const persona2Id = autoConvPersona2Select.value;
                const persona1 = getPersonaById(persona1Id);
                const persona2 = getPersonaById(persona2Id);

                if (!persona1 || !persona2) { 
                    addMessageToAutoConversationUI("Erro: Uma das personas selecionadas não foi encontrada.", "Sistema", true, true);
                    stopAutoConversation(true);
                    return;
                }

                let activePersona, activePersonaId, activePersonaName;
                let opponentPersona, opponentPersonaName;

                if (autoConversationTurn === 0) { 
                    activePersonaId = persona1Id; activePersona = persona1; opponentPersona = persona2;
                } else { 
                    activePersonaId = persona2Id; activePersona = persona2; opponentPersona = persona1;
                }
                activePersonaName = activePersona.name;
                opponentPersonaName = opponentPersona.name;
                
                addMessageToAutoConversationUI(`${activePersonaName} está pensando...`, "Sistema", false, true);

                let messagesForApiForThisTurn = [...autoConversationHistory];
                
                try {
                    const responseText = await getAutoGroqResponse(activePersonaId, messagesForApiForThisTurn, opponentPersonaName);
                    
                    const systemMessagesInUI = autoConversationMessagesContainerEl.querySelectorAll('.message-wrapper');
                    if(systemMessagesInUI.length > 0) {
                        const lastSystemMessage = systemMessagesInUI[systemMessagesInUI.length -1];
                        if(lastSystemMessage && lastSystemMessage.querySelector('.message-avatar').title === "Sistema" && lastSystemMessage.textContent.includes("está pensando...")){
                            lastSystemMessage.remove();
                        }
                    }

                    if (responseText) {
                        addMessageToAutoConversationUI(responseText, activePersonaName);
                        autoConversationHistory.push({ speaker: activePersonaName, content: responseText }); 
                        
                        autoConversationTurn = 1 - autoConversationTurn; 
                        if (isAutoConversationRunning) { 
                            autoConversationIntervalId = setTimeout(autoConversationLoop, AUTO_CONV_DELAY_MS);
                        }
                    } else {
                        addMessageToAutoConversationUI(`${activePersonaName} não respondeu ou a resposta foi vazia.`, "Sistema", false, true);
                         if (isAutoConversationRunning) {
                            autoConversationIntervalId = setTimeout(autoConversationLoop, AUTO_CONV_DELAY_MS / 2); 
                        } else {
                            stopAutoConversation(true);
                        }
                    }
                } catch (error) {
                    const systemMessagesInUI = autoConversationMessagesContainerEl.querySelectorAll('.message-wrapper');
                    if(systemMessagesInUI.length > 0) {
                        const lastSystemMessage = systemMessagesInUI[systemMessagesInUI.length -1];
                        if(lastSystemMessage && lastSystemMessage.querySelector('.message-avatar').title === "Sistema" && lastSystemMessage.textContent.includes("está pensando...")){
                            lastSystemMessage.remove();
                        }
                    }
                    console.error("Erro no loop da auto-conversa:", error);
                    addMessageToAutoConversationUI(`Erro com ${activePersonaName}: ${error.message}`, "Sistema", true, true);
                    stopAutoConversation(true); 
                }
            }

            function startOrContinueAutoConversation() {
                const persona1Id = autoConvPersona1Select.value;
                const persona2Id = autoConvPersona2Select.value;

                if (!persona1Id || !persona2Id) {
                    alert("Por favor, selecione duas Personas para conversar."); return;
                }
                if (persona1Id === persona2Id) {
                    alert("Por favor, selecione duas Personas diferentes."); return;
                }

                isAutoConversationRunning = true;
                
                autoConversationHistory = [];
                autoConversationTurn = 0; 
                autoConversationMessagesContainerEl.innerHTML = ''; 
                const p1Name = getPersonaById(persona1Id)?.name || 'Persona 1';
                const p2Name = getPersonaById(persona2Id)?.name || 'Persona 2';
                addMessageToAutoConversationUI(`Iniciando conversa entre ${p1Name} e ${p2Name}...`, "Sistema", false, true);
                
                startAutoConversationBtn.disabled = true;
                stopAutoConversationBtn.disabled = false;
                autoConvPersona1Select.disabled = true;
                autoConvPersona2Select.disabled = true;
                startAutoConversationBtn.textContent = "Conversa em Andamento...";

                autoConversationLoop(); 
            }

            function stopAutoConversation(showStopMessageInModal = true) {
                isAutoConversationRunning = false;
                if (autoConversationIntervalId) {
                    clearTimeout(autoConversationIntervalId);
                    autoConversationIntervalId = null;
                }
                if (autoConversationAbortController) {
                    autoConversationAbortController.abort();
                    autoConversationAbortController = null;
                }

                if (startAutoConversationBtn) {
                     startAutoConversationBtn.disabled = false;
                     startAutoConversationBtn.textContent = "Iniciar Conversa";
                }
                if (stopAutoConversationBtn) stopAutoConversationBtn.disabled = true;
                if (autoConvPersona1Select) autoConvPersona1Select.disabled = false;
                if (autoConvPersona2Select) autoConvPersona2Select.disabled = false;
                
                if (showStopMessageInModal && autoConversationModal.style.display === 'flex' && autoConversationHistory.length > 0) {
                     addMessageToAutoConversationUI("Conversa automática interrompida.", "Sistema", false, true);
                }
            }
            
            if (openAutoConversationModeBtn) openAutoConversationModeBtn.addEventListener('click', openAutoConversationModal);
            if (closeAutoConversationModalBtn) closeAutoConversationModalBtn.addEventListener('click', closeAutoConversationModal);
            if (startAutoConversationBtn) startAutoConversationBtn.addEventListener('click', startOrContinueAutoConversation);
            if (stopAutoConversationBtn) stopAutoConversationBtn.addEventListener('click', () => stopAutoConversation(true));


            loadCustomPersonas(); loadUserMemory(); loadInitialTheme();
            const apiKeyPresent = loadUserApiKey(); loadPrompts();
            if (apiKeyPresent) {
                loadConversations(); const currentConv = getActiveConversation();
                if (currentConv && currentConv.messages.length === 0) { addInitialBotMessageToUI(); }
                else if (!currentConv && allConversations.length === 0) { displayInitialGreetingAndSuggestion(); }
                else if (!currentConv && allConversations.length > 0) { setActiveConversation(allConversations[0].id); }
                else { displayInitialGreetingAndSuggestion(); } 
            }
            updateTokenCountDisplay();
        });
    </script>
</body>
</html>
